<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ninja Shoutout</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Ninja Shoutout">

  <style>
    :root{
      --bg1:#0ea5e9;
      --bg2:#2563eb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#2563eb;
      --brand-soft:#dbeafe;
      --border:#e5e7eb;
      --radius:18px;
      --shadow:0 14px 40px rgba(15,23,42,.18),0 3px 10px rgba(15,23,42,.10);
      --ok:#22c55e;
      --error:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    html,body{
      min-height:100vh;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment:fixed;
    }

    body{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
    }

    .wrap{
      width:100%;
      max-width:880px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    header{
      text-align:center;
      color:#e5edff;
    }
    header .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    header img.logo{
      height:40px;
      width:auto;
      filter:drop-shadow(0 1px 2px rgba(15,23,42,.35));
    }
    header h1{
      margin:10px 0 4px;
      font-size:clamp(22px,4vw,32px);
      font-weight:800;
    }
    header p{
      margin:0;
      font-size:14px;
      color:#bfdbfe;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px 18px 16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter:saturate(1.2) blur(4px);
    }

    .step-header{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .step-number{
      width:26px;
      height:26px;
      border-radius:999px;
      background:var(--brand-soft);
      color:var(--brand);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:13px;
      flex-shrink:0;
    }
    .step-header h2{
      margin:0;
      font-size:18px;
      font-weight:800;
      color:#0f172a;
    }
    .step-description{
      margin:2px 0 0;
      font-size:13px;
      color:var(--muted);
    }

    .question-container{
      margin:6px 0 10px;
    }

    label.field-label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:#0f172a;
      margin-bottom:4px;
    }

    input[type="text"],
    input[type="file"],
    textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:14px;
      font-family:inherit;
      transition:all .18s ease;
      background:#f8fafc;
      color:var(--ink);
    }
    input[type="text"]:focus,
    textarea:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 2px rgba(37,99,235,.14);
      background:#ffffff;
    }

    input[type="file"]{
      padding:8px 10px;
      background:#f9fafb;
    }

    textarea{
      min-height:150px;
      resize:vertical;
      line-height:1.5;
    }

    .options-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:8px;
      margin-top:4px;
    }

    .shoutout-option{
      display:block;
      border-radius:12px;
      padding:10px;
      border:1px solid var(--border);
      cursor:pointer;
      transition:all .18s ease;
      background:#ffffff;
    }

    .shoutout-option:hover{
      border-color:var(--brand);
      box-shadow:0 4px 14px rgba(15,23,42,.06);
      transform:translateY(-1px);
    }

    .shoutout-option input{
      display:none;
    }

    .shoutout-option.selected{
      border-color:var(--brand);
      background:var(--brand-soft);
    }

    .option-content{
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:13px;
      color:#0f172a;
    }
    .option-icon{
      font-size:18px;
      line-height:1;
      margin-top:1px;
    }
    .option-text{
      font-weight:500;
    }
    .option-sub{
      font-size:11px;
      color:#6b7280;
      margin-top:2px;
      font-weight:400;
    }

    .inline-note{
      font-size:11px;
      color:#6b7280;
      padding:6px 8px;
      border-radius:8px;
      background:#eff6ff;
      margin-top:6px;
    }

    .btn{
      appearance:none;
      border-radius:12px;
      padding:11px 14px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      min-height:40px;
      white-space:nowrap;
      transition:all .18s ease;
    }
    .btn.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#ffffff;
      box-shadow:0 4px 14px rgba(37,99,235,.35);
    }
    .btn.ghost{
      background:#ffffff;
      color:#0f172a;
    }
    .btn:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.14);
    }
    .btn.primary:hover:not(:disabled){
      background:#1d4ed8;
      border-color:#1d4ed8;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .actions-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
    }

    .banner{
      display:none;
      margin-top:10px;
      padding:9px 10px;
      border-radius:10px;
      font-size:12px;
    }
    .banner.ok{
      background:rgba(22,163,74,.08);
      color:#15803d;
      border:1px solid rgba(22,163,74,.35);
    }
    .banner.error{
      background:rgba(239,68,68,.06);
      color:#b91c1c;
      border:1px solid rgba(239,68,68,.35);
    }

    .canvas-wrap{
      margin-top:12px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:10px;
      background:#f8fafc;
    }
    .canvas-inner{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-start;
    }
    canvas{
      width:100%;
      max-width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#020617;
    }

    .step{
      display:none;
      animation:fade .22s ease;
    }
    .step.active{
      display:block;
    }
    @keyframes fade{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:translateY(0);}
    }

    @media (max-width:640px){
      body{
        padding:12px;
        align-items:flex-start;
      }
      .card{padding:14px;}
      .actions-row{
        flex-direction:column;
        align-items:stretch;
      }
      .actions-row .btn{
        width:100%;
        justify-content:center;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo" src="https://www.codeninjas.com/hubfs/Group%201.svg" alt="Code Ninjas logo" onerror="this.style.display='none'">
      </div>
      <h1>Ninja Shout-Out Builder</h1>
      <p>Type a Ninja‚Äôs name, pick what you‚Äôre celebrating, and we‚Äôll auto-build a text message and shout-out graphic.</p>
    </header>

    <section class="card" aria-live="polite">
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <div>
            <h2>Who are we celebrating today?</h2>
            <p class="step-description">
              Fill in the Ninja‚Äôs name and choose a shout-out type. Birthday + tour have special offers baked into the text.
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="ninjaName" class="field-label">Ninja‚Äôs name</label>
          <input id="ninjaName" type="text" placeholder="e.g., Alex, Sophia, Ethan" autocomplete="off" />
        </div>

        <div class="question-container">
          <label for="senderName" class="field-label">Sender name (who is texting?)</label>
          <input id="senderName" type="text" placeholder="e.g., Marina" value="Marina" autocomplete="off" />
          <div class="inline-note">
            This name will appear in the text as: <em>‚ÄúHi! This is &lt;name&gt; from Code Ninjas Cooper City‚Ä¶‚Äù</em>
          </div>
        </div>

        <div class="question-container">
          <label class="field-label">What are we shouting them out for?</label>
          <div class="options-grid" id="shoutoutGrid">
            <label class="shoutout-option">
              <input type="radio" name="reason" value="belt">
              <div class="option-content">
                <div class="option-icon">üéâ</div>
                <div>
                  <div class="option-text">Belt-up celebration</div>
                  <div class="option-sub">Leveling up their belt in the dojo.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="project">
              <div class="option-content">
                <div class="option-icon">üíª</div>
                <div>
                  <div class="option-text">Cool project</div>
                  <div class="option-sub">Finished something awesome in class.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="outstanding">
              <div class="option-content">
                <div class="option-icon">‚≠ê</div>
                <div>
                  <div class="option-text">Outstanding student</div>
                  <div class="option-sub">Focus, effort, and all-around rockstar Ninja.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="behavior">
              <div class="option-content">
                <div class="option-icon">üòä</div>
                <div>
                  <div class="option-text">Well-behaved</div>
                  <div class="option-sub">Respectful, kind, and a great example.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="helper">
              <div class="option-content">
                <div class="option-icon">ü§ù</div>
                <div>
                  <div class="option-text">Helped another student</div>
                  <div class="option-sub">Showing leadership and teamwork.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="attendance">
              <div class="option-content">
                <div class="option-icon">üìÖ</div>
                <div>
                  <div class="option-text">Great attendance</div>
                  <div class="option-sub">Showing up consistently to level up.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="leadership">
              <div class="option-content">
                <div class="option-icon">üß†</div>
                <div>
                  <div class="option-text">Leadership / teamwork</div>
                  <div class="option-sub">Going above and beyond with others.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="birthday">
              <div class="option-content">
                <div class="option-icon">üéÇ</div>
                <div>
                  <div class="option-text">Birthday shout-out</div>
                  <div class="option-sub">We loved celebrating their special day.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="tour">
              <div class="option-content">
                <div class="option-icon">üèØ</div>
                <div>
                  <div class="option-text">Tour follow-up</div>
                  <div class="option-sub">Invite them back after their dojo tour.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="custom">
              <div class="option-content">
                <div class="option-icon">‚ú®</div>
                <div>
                  <div class="option-text">Custom shout-out</div>
                  <div class="option-sub">Use your own wording (focus, kindness, etc.).</div>
                </div>
              </div>
            </label>
          </div>

          <div style="margin-top:8px;">
            <label for="customReason" class="field-label">If custom, what are we celebrating? (optional)</label>
            <input
              id="customReason"
              type="text"
              placeholder='e.g., "amazing focus today", "being so kind to others"'
              autocomplete="off"
            />
            <div class="inline-note">
              If you choose ‚ÄúCustom shout-out‚Äù above, we‚Äôll plug this reason into both the text and the image.
            </div>
          </div>
        </div>

        <div class="question-container" id="senseiRow" style="display:none;">
          <label for="senseiName" class="field-label">Sensei in the picture (for tour texts)</label>
          <input
            id="senseiName"
            type="text"
            placeholder='e.g., "Sensei Alex"'
            autocomplete="off"
          />
          <div class="inline-note">
            We‚Äôll use this as: <em>‚ÄúSensei Alex had such a fun time with Ethan during their tour today!‚Äù</em>
          </div>
        </div>

        <div class="actions-row">
          <button class="btn primary" type="button" id="next1" disabled>
            Next ‚ñ∂
          </button>
        </div>
      </div>

      <div class="step" id="step2">
        <div class="step-header" style="margin-top:0;">
          <div class="step-number">2</div>
          <div>
            <h2>Text message preview</h2>
            <p class="step-description">
              Generate the text we‚Äôll send to the parent. Birthday adds the $249 1+1 bundle offer; tours add the TOUR promo (no enrollment fee).
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="messageOutput" class="field-label">Message to parent (SMS)</label>
          <textarea
            id="messageOutput"
            placeholder="Click ‚ÄúGenerate shout-out‚Äù to build your text."
            readonly
          ></textarea>
        </div>

        <div class="actions-row">
          <button class="btn ghost" type="button" id="back2">
            ‚óÄ Back
          </button>
          <button class="btn ghost" type="button" id="generateBtn">
            ‚ú® Generate shout-out
          </button>
          <button class="btn primary" type="button" id="copyBtn">
            üìã Copy text message
          </button>
          <button class="btn" type="button" id="next2" disabled>
            Next ‚ñ∂
          </button>
        </div>
      </div>

      <div class="step" id="step3">
        <div class="step-header" style="margin-top:0;">
          <div class="step-number">3</div>
          <div>
            <h2>Ninja shout-out picture</h2>
            <p class="step-description">
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="photoInput" class="field-label">Ninja photo</label>
          <input id="photoInput" type="file" accept="image/*" />
          <div class="inline-note">
            Tip: Use a landscape photo if possible. Make sure <strong>ninja-shoutout-frame.png</strong> is in the same folder as this file.
          </div>
        </div>

        <div class="canvas-wrap">
          <div class="canvas-inner">
            <canvas id="shoutoutCanvas" width="1650" height="1275"></canvas>
            <div class="actions-row" style="justify-content:flex-start;margin-top:4px;">
              <button class="btn ghost" type="button" id="back3">
                ‚óÄ Back
              </button>
              <button class="btn ghost" type="button" id="renderImageBtn">
                üñº Generate shout-out image
              </button>
              <button class="btn" type="button" id="downloadImageBtn" disabled>
                ‚¨á Download image
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="okBanner" class="banner ok"></div>
      <div id="errBanner" class="banner error"></div>
    </section>
  </div>

  <script>
    function baseStandardMessage(ninjaName, content, senderName){
      const sender = (senderName || "Marina").trim();
      return (
        `Hi! This is ${sender} from Code Ninjas Cooper City ü•∑üíô\n\n` +
        content +
        `\n\nAs a thank-you, if you share the picture we took today on ANY social media platform, you‚Äôll receive $99 off your membership for every person that signs up for a membership because of your post! üéâ`
      );
    }

    function baseBirthdayMessage(ninjaName, content, senderName){
      const sender = (senderName || "Marina").trim();
      const name = (ninjaName || "").trim();
      return (
        `Hi! This is ${sender} from Code Ninjas Cooper City ü•∑üíô\n\n` +
        content +
        `\n\nWe loved celebrating ${name} today! üéÇ As a birthday bonus, we‚Äôd love to invite you to our 1+1 CREATE + Clubs bundle for a special discounted rate of $249. Let us know if you‚Äôd like more details!`
      );
    }

    function baseTourMessage(ninjaName, content, senderName){
      const sender = (senderName || "Marina").trim();
      const name = (ninjaName || "").trim();
      return (
        `Hi! This is ${sender} from Code Ninjas Cooper City ü•∑üíô\n\n` +
        content +
        `\n\nWe‚Äôre so excited to see ${name} back in the dojo! When you‚Äôre ready to sign up at CodeNinjas.com, you can use code TOUR for NO enrollment fee for up to two weeks. üéÆ`
      );
    }

    const coreTemplates = {
      belt: [
        (n) => `${n} leveled up their belt today! üéâ Their hard work and persistence really paid off in the dojo!`,
        (n) => `${n} earned a new belt today and we‚Äôre SO proud! Their consistency in class is really showing! ü•∑`,
        (n) => `${n} crushed it and ranked up their belt today ‚Äî amazing progress and effort! ‚ú®`
      ],
      project: [
        (n) => `${n} built a really awesome coding project today! üíª We were super impressed with their creativity and problem-solving.`,
        (n) => `${n} completed an impressive project today and showed great focus and persistence from start to finish!`,
        (n) => `${n} showed strong skills and creativity today with a very cool project in class!`
      ],
      outstanding: [
        (n) => `${n} stood out as an outstanding Ninja today ‚Äî great focus, effort, and attitude! ‚≠ê`,
        (n) => `${n} was an exceptional student today, participating, staying engaged, and giving their best effort the whole time!`,
        (n) => `${n} has been showing incredible progress and consistency in the dojo ‚Äî we‚Äôre really proud of them!`
      ],
      behavior: [
        (n) => `${n} showed excellent behavior today ‚Äî respectful, focused, and kind to others! üòä`,
        (n) => `${n} was so well-behaved and set a great example for other Ninjas in the dojo today!`,
        (n) => `${n} had awesome behavior today and helped keep the dojo a fun, positive space for everyone!`
      ],
      helper: [
        (n) => `${n} helped another student in class today ‚Äî amazing kindness, patience, and leadership! ü§ù`,
        (n) => `${n} went out of their way to support a fellow Ninja today. We love seeing that teamwork!`,
        (n) => `${n} showed great leadership and teamwork by helping other students during class today!`
      ],
      attendance: [
        (n) => `${n} has had fantastic attendance lately ‚Äî that consistency is really helping them grow! üìÖ`,
        (n) => `${n} has been so committed to showing up regularly, and we‚Äôre seeing great progress because of it!`,
        (n) => `${n} is progressing quickly thanks to their strong and consistent attendance at Code Ninjas!`
      ],
      leadership: [
        (n) => `${n} showed strong leadership and teamwork in the dojo today ‚Äî encouraging others and working so well with the group! üß†`,
        (n) => `${n} really stepped up today and demonstrated great leadership skills in class!`,
        (n) => `${n} was a positive leader and role model in the dojo today ‚Äî we really appreciated their attitude and support of others!`
      ],
      birthday: [
        (n) => `We loved celebrating ${n}‚Äôs birthday at the dojo today! üéÇ`,
        (n) => `Happy birthday to ${n}! üéâ We had such a fun time celebrating with them at Code Ninjas.`,
        (n) => `${n} had an awesome birthday with us at Code Ninjas today ‚Äî we loved celebrating with them! üéÇ`
      ]
    };

    function randomFrom(arr){
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function buildCoreMessage(name, reason, customReason, senseiName){
      const trimmedName = (name || "").trim();
      if(!trimmedName) return "";

      if(reason === "custom"){
        const detail = (customReason || "").trim() || "doing something awesome in the dojo today";
        return `${trimmedName} earned a special shout-out today for ${detail}! ‚ú®`;
      }

      if(reason === "tour"){
        const s = (senseiName || "").trim();
        if(s){
          return `${s} had such a fun time with ${trimmedName} during their tour today! We loved showing them around the dojo.`;
        }else{
          return `${trimmedName} had such a fun tour at the dojo today! We loved meeting them and showing them what Code Ninjas is all about!`;
        }
      }

      const options = coreTemplates[reason];
      if(!options || !options.length) return "";
      return randomFrom(options)(trimmedName);
    }

    function buildFullSms(name, reason, customReason, senderName, senseiName){
      const core = buildCoreMessage(name, reason, customReason, senseiName);
      if(!core) return "";

      if(reason === "birthday"){
        return baseBirthdayMessage(name.trim(), core, senderName);
      }
      if(reason === "tour"){
        return baseTourMessage(name.trim(), core, senderName);
      }
      return baseStandardMessage(name.trim(), core, senderName);
    }

    function showOk(msg){
      const el = document.getElementById("okBanner");
      el.textContent = msg || "Copied! You can paste this into your text app. üì≤";
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 3500);
    }

    function showErr(msg){
      const el = document.getElementById("errBanner");
      el.textContent = msg || "Something went wrong. Please try again.";
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 4000);
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }
    }

    let userImage = null;
    let frameImage = null;
    let frameLoaded = false;
    let latestCoreMessage = "";
    let currentReason = "";
    let currentNinjaName = "";

    const canvas = document.getElementById("shoutoutCanvas");
    const ctx = canvas.getContext("2d");

    function loadFrame(){
      frameImage = new Image();
      frameImage.onload = function(){
        frameLoaded = true;
      };
      frameImage.src = "ninja-shoutout-frame.png";
    }

    function handlePhotoFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const img = new Image();
        img.onload = function(){
          userImage = img;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function drawCoverImage(img, ctx, width, height){
      const iw = img.width;
      const ih = img.height;
      if(!iw || !ih) return;

      const scale = Math.max(width/iw, height/ih);
      const sw = iw*scale;
      const sh = ih*scale;
      const sx = (width - sw)/2;
      const sy = (height - sh)/2;
      ctx.drawImage(img, sx, sy, sw, sh);
    }

    function renderShoutoutText() {
      let message = latestCoreMessage;
      if (!message) return;

      if (currentReason === "birthday") {
        const name = currentNinjaName || "your Ninja";
        const offerLine = `We loved celebrating ${name} today! üéÇ Special birthday offer: 1+1 CREATE + Clubs bundle for $249 if you sign up within the next two weeks!`;
        message = message + " " + offerLine;
      }

      const w = canvas.width;
      const h = canvas.height;

      ctx.font = "36px system-ui, -apple-system, 'Segoe UI', sans-serif";
      ctx.fillStyle = "#ffffff";
      ctx.textBaseline = "top";

      const maxWidth = 700;
      const lineHeight = 50;

      const words = message.split(/\s+/);
      let lines = [];
      let line = "";

      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + " ";
        if (ctx.measureText(testLine).width > maxWidth && n > 0) {
          lines.push(line);
          line = words[n] + " ";
        } else {
          line = testLine;
        }
      }
      if (line) lines.push(line);

      const textHeight = lines.length * lineHeight;

      const margin = 80;
      const bgWidth = maxWidth + 60;
      const bgHeight = textHeight + 100;

      const bgX = w - bgWidth - margin;
      const bgY = h - bgHeight - margin;
      ctx.fillStyle = "rgba(0,0,0,0.45)";
      ctx.beginPath();
      if (ctx.roundRect) ctx.roundRect(bgX, bgY, bgWidth, bgHeight, 25);
      else ctx.rect(bgX, bgY, bgWidth, bgHeight);
      ctx.fill();

      ctx.fillStyle = "#ffffff";
      let textX = bgX + 30;
      let textY = bgY + 20;

      lines.forEach(l => {
        ctx.fillText(l.trim(), textX, textY);
        textY += lineHeight;
      });

      ctx.font = "28px system-ui, -apple-system, 'Segoe UI', sans-serif";
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.fillText("Visit CodeNinjas.com to learn more!", textX, textY + 10);
    }

    function renderShoutoutImage(){
      if(!latestCoreMessage){
        showErr("Generate a shout-out first so we know what text to place on the image.");
        return;
      }
      if(!userImage){
        showErr("Please upload a Ninja photo first.");
        return;
      }
      if(!frameLoaded){
        showErr("Frame image is still loading. Wait a moment and try again.");
        return;
      }

      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0,0,w,h);

      drawCoverImage(userImage, ctx, w, h);

      ctx.drawImage(frameImage, 0, 0, w, h);

      renderShoutoutText();
    }

    document.addEventListener("DOMContentLoaded", function(){
      loadFrame();

      const nameInput = document.getElementById("ninjaName");
      const senderInput = document.getElementById("senderName");
      const customInput = document.getElementById("customReason");
      const senseiInput = document.getElementById("senseiName");
      const senseiRow = document.getElementById("senseiRow");
      const output = document.getElementById("messageOutput");
      const generateBtn = document.getElementById("generateBtn");
      const copyBtn = document.getElementById("copyBtn");
      const optionCards = document.querySelectorAll(".shoutout-option");
      const photoInput = document.getElementById("photoInput");
      const renderImageBtn = document.getElementById("renderImageBtn");
      const downloadImageBtn = document.getElementById("downloadImageBtn");

      const next1 = document.getElementById("next1");
      const back2 = document.getElementById("back2");
      const next2 = document.getElementById("next2");
      const back3 = document.getElementById("back3");

      let currentStep = 1;
      function showStep(step){
        document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
        const el = document.getElementById("step"+step);
        if(el) el.classList.add("active");
        currentStep = step;
      }

      function getSelectedReason(){
        const checked = document.querySelector('input[name="reason"]:checked');
        return checked ? checked.value : "";
      }

      function updateSelectionVisuals(){
        optionCards.forEach(card => {
          const input = card.querySelector("input");
          card.classList.toggle("selected", !!(input && input.checked));
        });

        const reason = getSelectedReason();
        if(reason === "tour"){
          senseiRow.style.display = "block";
        }else{
          senseiRow.style.display = "none";
        }
        updateStep1Next();
      }

      function updateStep1Next(){
        const hasName = !!nameInput.value.trim();
        const hasReason = !!getSelectedReason();
        next1.disabled = !(hasName && hasReason);
      }

      function updateStep2Next(){
        const hasText = !!(output.value || "").trim();
        next2.disabled = !hasText;
      }

      optionCards.forEach(card => {
        card.addEventListener("click", () => {
          const input = card.querySelector("input");
          if(input){
            input.checked = true;
            updateSelectionVisuals();
          }
        });
      });

      document.querySelectorAll('input[name="reason"]').forEach(i => {
        i.addEventListener("change", updateSelectionVisuals);
      });

      nameInput.addEventListener("input", updateStep1Next);

      next1.addEventListener("click", () => {
        showStep(2);
      });

      back2.addEventListener("click", () => {
        showStep(1);
      });

      next2.addEventListener("click", () => {
        showStep(3);
      });

      back3.addEventListener("click", () => {
        showStep(2);
      });

      generateBtn.addEventListener("click", () => {
        const name = nameInput.value;
        const reason = getSelectedReason();
        const custom = customInput.value;
        const senderName = senderInput.value || "Marina";
        const senseiName = senseiInput.value;

        if(!name.trim()){
          showErr("Please enter the Ninja‚Äôs name first.");
          nameInput.focus();
          return;
        }
        if(!reason){
          showErr("Please choose what you‚Äôre shouting them out for.");
          showStep(1);
          return;
        }

        const core = buildCoreMessage(name, reason, custom, senseiName);
        if(!core){
          showErr("Could not generate message. Try again.");
          return;
        }
        latestCoreMessage = core;
        currentReason = reason;
        currentNinjaName = (name || "").trim();

        const fullSms = buildFullSms(name, reason, custom, senderName, senseiName);
        output.value = fullSms;
        updateStep2Next();
        showOk("Shout-out generated!");
      });

      copyBtn.addEventListener("click", async () => {
        const text = (output.value || "").trim();
        if(!text){
          showErr("Generate a shout-out first, then copy it.");
          return;
        }
        const ok = await copyToClipboard(text);
        if(ok){
          showOk("Copied! Paste into your text app or CRM. üì≤");
        }else{
          showErr("Couldn‚Äôt copy automatically. Please select and copy manually.");
        }
      });

      photoInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if(file){
          handlePhotoFile(file);
          showOk("Photo loaded! Click ‚ÄúGenerate shout-out image‚Äù to apply the frame.");
        }
      });

      renderImageBtn.addEventListener("click", () => {
        renderShoutoutImage();
        downloadImageBtn.disabled = false;
      });

      downloadImageBtn.addEventListener("click", () => {
        const dataUrl = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = "ninja-shoutout.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      showStep(1);
      updateStep1Next();
      updateStep2Next();
    });
  </script>
</body>
</html>
