<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ninja Shoutout</title>

  <!-- iPad / iPhone web app meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Ninja Shoutout">
  <!-- Home screen icon (put icon-180.png in same folder) -->
  <link rel="apple-touch-icon" href="icon-180.png">

  <style>
    :root{
      --bg1:#0ea5e9;
      --bg2:#2563eb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#2563eb;
      --brand-soft:#dbeafe;
      --border:#e5e7eb;
      --radius:18px;
      --shadow:0 14px 40px rgba(15,23,42,.18),0 3px 10px rgba(15,23,42,.10);
      --ok:#22c55e;
      --error:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    html,body{
      min-height:100vh;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment:fixed;
    }

    body{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
    }

    .wrap{
      width:100%;
      max-width:880px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    header{
      text-align:center;
      color:#e5edff;
    }
    header .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    header img.logo{
      height:40px;
      width:auto;
      filter:drop-shadow(0 1px 2px rgba(15,23,42,.35));
    }
    header h1{
      margin:10px 0 4px;
      font-size:clamp(22px,4vw,32px);
      font-weight:800;
    }
    header p{
      margin:0;
      font-size:14px;
      color:#bfdbfe;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px 18px 16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter:saturate(1.2) blur(4px);
    }

    .step-header{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .step-number{
      width:26px;
      height:26px;
      border-radius:999px;
      background:var(--brand-soft);
      color:var(--brand);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:13px;
      flex-shrink:0;
    }
    .step-header h2{
      margin:0;
      font-size:18px;
      font-weight:800;
      color:#0f172a;
    }
    .step-description{
      margin:2px 0 0;
      font-size:13px;
      color:var(--muted);
    }

    .question-container{
      margin:6px 0 10px;
    }

    label.field-label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:#0f172a;
      margin-bottom:4px;
    }

    input[type="text"],
    input[type="file"],
    textarea,
    select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:14px;
      font-family:inherit;
      transition:all .18s ease;
      background:#f8fafc;
      color:var(--ink);
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 2px rgba(37,99,235,.14);
      background:#ffffff;
    }

    input[type="file"]{
      padding:8px 10px;
      background:#f9fafb;
    }

    textarea{
      min-height:150px;
      resize:vertical;
      line-height:1.5;
    }

    .options-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:8px;
      margin-top:4px;
    }

    .shoutout-option{
      display:block;
      border-radius:12px;
      padding:10px;
      border:1px solid var(--border);
      cursor:pointer;
      transition:all .18s ease;
      background:#ffffff;
    }

    .shoutout-option:hover{
      border-color:var(--brand);
      box-shadow:0 4px 14px rgba(15,23,42,.06);
      transform:translateY(-1px);
    }

    .shoutout-option input{
      display:none;
    }

    .shoutout-option.selected{
      border-color:var(--brand);
      background:var(--brand-soft);
    }

    .option-content{
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:13px;
      color:#0f172a;
    }
    .option-icon{
      font-size:18px;
      line-height:1;
      margin-top:1px;
    }
    .option-text{
      font-weight:500;
    }
    .option-sub{
      font-size:11px;
      color:#6b7280;
      margin-top:2px;
      font-weight:400;
    }

    .inline-note{
      font-size:11px;
      color:#6b7280;
      padding:6px 8px;
      border-radius:8px;
      background:#eff6ff;
      margin-top:6px;
    }

    .btn{
      appearance:none;
      border-radius:12px;
      padding:11px 14px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      min-height:40px;
      white-space:nowrap;
      transition:all .18s ease;
    }
    .btn.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#ffffff;
      box-shadow:0 4px 14px rgba(37,99,235,.35);
    }
    .btn.ghost{
      background:#ffffff;
      color:#0f172a;
    }
    .btn:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(15,23,42,.14);
    }
    .btn.primary:hover:not(:disabled){
      background:#1d4ed8;
      border-color:#1d4ed8;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .actions-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-top:10px;
    }

    .banner{
      display:none;
      margin-top:10px;
      padding:9px 10px;
      border-radius:10px;
      font-size:12px;
    }
    .banner.ok{
      background:rgba(22,163,74,.08);
      color:#15803d;
      border:1px solid rgba(22,163,74,.35);
    }
    .banner.error{
      background:rgba(239,68,68,.06);
      color:#b91c1c;
      border:1px solid rgba(239,68,68,.35);
    }

    .canvas-wrap{
      margin-top:12px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:10px;
      background:#f8fafc;
    }
    .canvas-inner{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-start;
    }
    .canvas-row{
      width:100%;
    }
    canvas{
      width:100%;
      max-width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#020617;
      display:block;
    }

    .photo-controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:8px;
      margin-top:4px;
    }
    .slider-field{
      font-size:11px;
      color:#374151;
    }
    .slider-field label{
      display:flex;
      justify-content:space-between;
      margin-bottom:2px;
      font-weight:600;
    }
    .slider-field input[type="range"]{
      width:100%;
    }

    /* Step system */
    .step{
      display:none;
      animation:fade .22s ease;
    }
    .step.active{
      display:block;
    }
    @keyframes fade{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:translateY(0);}
    }

    @media (max-width:640px){
      body{
        padding:12px;
        align-items:flex-start;
      }
      .card{padding:14px;}
      .actions-row{
        flex-direction:column;
        align-items:stretch;
      }
      .actions-row .btn{
        width:100%;
        justify-content:center;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo" src="https://www.codeninjas.com/hubfs/Group%201.svg" alt="Code Ninjas logo" onerror="this.style.display='none'">
      </div>
      <h1>Ninja Shout-Out Builder</h1>
      <p>Type a Ninja‚Äôs name, pick what you‚Äôre celebrating, and we‚Äôll auto-build a message and two framed shout-out graphics.</p>
    </header>

    <section class="card" aria-live="polite">
      <!-- STEP 1: DETAILS -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <div>
            <h2>Who are we celebrating today?</h2>
            <p class="step-description">
              Fill in the Ninja‚Äôs name and choose a shout-out type. Birthday + tour have special offers baked into the text.
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="ninjaName" class="field-label">Ninja‚Äôs name</label>
          <input id="ninjaName" type="text" placeholder="e.g., Alex, Sophia, Ethan" autocomplete="off" />
        </div>

        <div class="question-container">
          <label for="parentName" class="field-label">Parent name (optional)</label>
          <input id="parentName" type="text" placeholder="e.g., Emma‚Äôs mom, Sarah" autocomplete="off" />
          <div class="inline-note">
            We‚Äôll start the message with ‚ÄúHi [Parent Name],‚Äù if you fill this in. Otherwise it will say ‚ÄúHi there,‚Äù.
          </div>
        </div>

        <div class="question-container">
          <label for="pronounSelect" class="field-label">Ninja pronouns</label>
          <select id="pronounSelect">
            <option value="they">They / their (default)</option>
            <option value="he">He / his</option>
            <option value="she">She / her</option>
          </select>
          <div class="inline-note">
            We‚Äôll use this to say ‚Äúhis belt‚Äù, ‚Äúher project‚Äù, or ‚Äútheir progress‚Äù.
          </div>
        </div>

        <div class="question-container">
          <label for="senderName" class="field-label">Sender name (who is texting?)</label>
          <input id="senderName" type="text" placeholder="e.g., Marina" value="Marina" autocomplete="off" />
          <div class="inline-note">
            This name will appear in the text as: <em>‚ÄúHi [Parent Name], This is &lt;name&gt; from Code Ninjas Cooper City‚Ä¶‚Äù</em>
          </div>
        </div>

        <div class="question-container">
          <label class="field-label">What are we shouting them out for?</label>
          <div class="options-grid" id="shoutoutGrid">
            <label class="shoutout-option">
              <input type="radio" name="reason" value="belt">
              <div class="option-content">
                <div class="option-icon">üéâ</div>
                <div>
                  <div class="option-text">Belt-up celebration</div>
                  <div class="option-sub">Leveling up their belt in the dojo.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="project">
              <div class="option-content">
                <div class="option-icon">üíª</div>
                <div>
                  <div class="option-text">Cool project</div>
                  <div class="option-sub">Finished something awesome in class.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="outstanding">
              <div class="option-content">
                <div class="option-icon">‚≠ê</div>
                <div>
                  <div class="option-text">Outstanding student</div>
                  <div class="option-sub">Focus, effort, and all-around rockstar Ninja.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="behavior">
              <div class="option-content">
                <div class="option-icon">üòä</div>
                <div>
                  <div class="option-text">Well-behaved</div>
                  <div class="option-sub">Respectful, kind, and a great example.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="helper">
              <div class="option-content">
                <div class="option-icon">ü§ù</div>
                <div>
                  <div class="option-text">Helped another student</div>
                  <div class="option-sub">Showing leadership and teamwork.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="attendance">
              <div class="option-content">
                <div class="option-icon">üìÖ</div>
                <div>
                  <div class="option-text">Great attendance</div>
                  <div class="option-sub">Showing up consistently to level up.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="leadership">
              <div class="option-content">
                <div class="option-icon">üß†</div>
                <div>
                  <div class="option-text">Leadership / teamwork</div>
                  <div class="option-sub">Going above and beyond with others.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="birthday">
              <div class="option-content">
                <div class="option-icon">üéÇ</div>
                <div>
                  <div class="option-text">Birthday shout-out</div>
                  <div class="option-sub">We loved celebrating their special day.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="tour">
              <div class="option-content">
                <div class="option-icon">üèØ</div>
                <div>
                  <div class="option-text">Tour follow-up</div>
                  <div class="option-sub">Invite them back after their dojo tour.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="custom">
              <div class="option-content">
                <div class="option-icon">‚ú®</div>
                <div>
                  <div class="option-text">Custom shout-out</div>
                  <div class="option-sub">Use your own wording (focus, kindness, etc.).</div>
                </div>
              </div>
            </label>
          </div>

          <div style="margin-top:8px;">
            <label for="customReason" class="field-label">If custom, what are we celebrating? (optional)</label>
            <input
              id="customReason"
              type="text"
              placeholder='e.g., "amazing focus today", "being so kind to others"'
              autocomplete="off"
            />
            <div class="inline-note">
              If you choose ‚ÄúCustom shout-out‚Äù above, we‚Äôll plug this reason into both the text and the image.
            </div>
          </div>
        </div>

        <div class="question-container" id="senseiRow" style="display:none;">
          <label for="senseiName" class="field-label">Sensei in the picture (for tour texts)</label>
          <input
            id="senseiName"
            type="text"
            placeholder='e.g., "Sensei Alex"'
            autocomplete="off"
          />
          <div class="inline-note">
            We‚Äôll use this as: <em>‚ÄúSensei Alex had such a fun time with Ethan during their tour today!‚Äù</em>
          </div>
        </div>

        <div class="actions-row">
          <button class="btn primary" type="button" id="next1" disabled>
            Next ‚ñ∂
          </button>
        </div>
      </div>

      <!-- STEP 2: TEXT MESSAGE -->
      <div class="step" id="step2">
        <div class="step-header" style="margin-top:0;">
          <div class="step-number">2</div>
          <div>
            <h2>Message preview</h2>
            <p class="step-description">
              Generate the warm, parent-friendly message. Birthday adds the $249 1+1 bundle; tours add the TOUR promo (no enrollment fee).
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="messageOutput" class="field-label">Message to parent (SMS or email)</label>
          <textarea
            id="messageOutput"
            placeholder="Click ‚ÄúGenerate shout-out‚Äù to build your message."
            readonly
          ></textarea>
        </div>

        <div class="actions-row">
          <button class="btn ghost" type="button" id="back2">
            ‚óÄ Back
          </button>
          <button class="btn ghost" type="button" id="generateBtn">
            ‚ú® Generate shout-out
          </button>
          <button class="btn primary" type="button" id="copyBtn">
            üìã Copy message
          </button>
          <button class="btn" type="button" id="next2" disabled>
            Next ‚ñ∂
          </button>
        </div>
      </div>

      <!-- STEP 3: IMAGE OVERLAY + EMAIL -->
      <div class="step" id="step3">
        <div class="step-header" style="margin-top:0;">
          <div class="step-number">3</div>
          <div>
            <h2>Ninja shout-out pictures</h2>
            <p class="step-description">
              Upload a photo and we‚Äôll overlay <strong>two frames:</strong> the classic landscape Ninja Shoutout frame and the vertical story frame you uploaded.
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="photoInput" class="field-label">Ninja photo</label>
          <input id="photoInput" type="file" accept="image/*" />
          <div class="inline-note">
            Make sure <strong>ninja-shoutout-frame.png</strong> (landscape) and <strong>Congratulations! (Your Story).png</strong> (vertical) are in the same folder as this HTML file.
          </div>
        </div>

        <!-- Zoom & pan controls -->
        <div class="photo-controls">
          <div class="slider-field">
            <label for="zoomSlider">
              <span>Zoom</span>
              <span id="zoomLabel">1.0√ó</span>
            </label>
            <input id="zoomSlider" type="range" min="0.6" max="2.0" step="0.02" value="1.0" />
          </div>
          <div class="slider-field">
            <label for="panXSlider">
              <span>Horizontal</span>
              <span id="panXLabel">0</span>
            </label>
            <input id="panXSlider" type="range" min="-100" max="100" step="1" value="0" />
          </div>
          <div class="slider-field">
            <label for="panYSlider">
              <span>Vertical</span>
              <span id="panYLabel">0</span>
            </label>
            <input id="panYSlider" type="range" min="-100" max="100" step="1" value="0" />
          </div>
        </div>

        <div class="canvas-wrap">
          <div class="canvas-inner">
            <div class="canvas-row">
              <label class="field-label">Classic landscape frame (for emails/texts)</label>
              <canvas id="shoutoutCanvasWide" width="1650" height="1275"></canvas>
            </div>

            <div class="canvas-row">
              <label class="field-label">Vertical story frame (for social media stories)</label>
              <canvas id="shoutoutCanvasStory" width="768" height="1365"></canvas>
            </div>

            <div class="actions-row" style="justify-content:flex-start;margin-top:4px;">
              <button class="btn ghost" type="button" id="back3">
                ‚óÄ Back
              </button>
              <button class="btn ghost" type="button" id="renderImageBtn">
                üñº Generate both images
              </button>
              <button class="btn" type="button" id="downloadWideBtn" disabled>
                ‚¨á Download landscape
              </button>
              <button class="btn" type="button" id="downloadStoryBtn" disabled>
                ‚¨á Download story
              </button>
              <button class="btn primary" type="button" id="emailBtn">
                ‚úâÔ∏è Email to center
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="okBanner" class="banner ok"></div>
      <div id="errBanner" class="banner error"></div>
    </section>
  </div>

  <script>
    // ===== PRONOUNS =====
    function getPronouns(code){
      let p;
      if(code === "he"){
        p = {subj:"he", obj:"him", possAdj:"his", possPron:"his", refl:"himself"};
      } else if(code === "she"){
        p = {subj:"she", obj:"her", possAdj:"her", possPron:"hers", refl:"herself"};
      } else {
        p = {subj:"they", obj:"them", possAdj:"their", possPron:"theirs", refl:"themselves"};
      }
      const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);
      return {
        ...p,
        subjCap: capitalize(p.subj),
        objCap: capitalize(p.obj),
        possAdjCap: capitalize(p.possAdj)
      };
    }

    // ===== TEXT TEMPLATES (SOFTER, EMAIL-LIKE) =====
    function baseStandardMessage(ninjaName, parentName, core, senderName, pronoun){
      const sender = (senderName || "Marina").trim();
      const child = (ninjaName || "your Ninja").trim();
      const parentLine = parentName && parentName.trim()
        ? `Hi ${parentName.trim()},`
        : "Hi there,";

      return (
        `${parentLine}\n` +
        `This is ${sender} from Code Ninjas Cooper City.\n\n` +
        `I just wanted to share how great ${child} was today. ${core}\n\n` +
        `I grabbed a quick photo of ${child} in the dojo and thought you might like it. If you‚Äôd like to share it with friends or family, feel free. üòä\n\n` +
        `Also, we recently launched our Give $99 / Get $99 referral perk. If you do end up sharing the picture and someone signs up because of your post, you‚Äôll get $99 off a future month and they‚Äôll get $99 off too. üéâ Totally optional‚Äîjust a fun way to share ${pronoun.possAdj} progress and save a little.\n\n` +
        `Thanks for being part of our dojo family! üíô`
      );
    }

    function baseBirthdayMessage(ninjaName, parentName, core, senderName, pronoun){
      const sender = (senderName || "Marina").trim();
      const child = (ninjaName || "your Ninja").trim();
      const parentLine = parentName && parentName.trim()
        ? `Hi ${parentName.trim()},`
        : "Hi there,";

      return (
        `${parentLine}\n` +
        `This is ${sender} from Code Ninjas Cooper City.\n\n` +
        `We loved celebrating ${child}‚Äôs birthday in the dojo today! ${core}\n\n` +
        `We snapped a quick picture of ${child} in action and thought you might like to have it. Feel free to share it with friends or family if you‚Äôd like. üéÇ\n\n` +
        `Since it was ${pronoun.possAdj} special day, we‚Äôre also running a birthday special: our 1+1 CREATE + Clubs bundle for a discounted rate of $249. If you‚Äôd ever like more details or want to check if it‚Äôs a good fit, I‚Äôm happy to share.\n\n` +
        `Thanks for letting us be part of ${child}‚Äôs day! üíô`
      );
    }

    function baseTourMessage(ninjaName, parentName, core, senderName){
      const sender = (senderName || "Marina").trim();
      const child = (ninjaName || "your Ninja").trim();
      const parentLine = parentName && parentName.trim()
        ? `Hi ${parentName.trim()},`
        : "Hi there,";

      return (
        `${parentLine}\n` +
        `This is ${sender} from Code Ninjas Cooper City.\n\n` +
        `${core}\n\n` +
        `We grabbed a quick photo from the tour and thought you might like it. üòä If you‚Äôd like to share it with friends or family, go for it.\n\n` +
        `Whenever you‚Äôre ready to get started, you can sign up at CodeNinjas.com and use code TOUR for no enrollment fee for up to two weeks. No pressure at all‚Äîjust wanted to pass the option along.\n\n` +
        `Thanks again for stopping by the dojo! üíô`
      );
    }

    const coreTemplates = {
      belt: [
        (n,p) => `${n} leveled up ${p.possAdj} belt today! ${p.subjCap} worked really hard and it paid off in the dojo. üôå`,
        (n,p) => `${n} earned a new belt today and ${p.possAdj} consistency in class is really starting to shine. We were all proud of ${p.obj}!`,
        (n,p) => `${n} crushed it and ranked up ${p.possAdj} belt today‚Äîsuch a great example of sticking with a challenge.`
      ],
      project: [
        (n,p) => `${n} built a really awesome coding project today! üíª ${p.subjCap} showed a ton of creativity and problem-solving.`,
        (n,p) => `${n} completed an impressive project today and stayed focused from start to finish.`,
        (n,p) => `${n} showed strong skills and creativity today with a very cool project in class.`
      ],
      outstanding: [
        (n,p) => `${n} stood out as an outstanding Ninja today‚Äîgreat focus, effort, and attitude the whole time. ‚≠ê`,
        (n,p) => `${n} was an exceptional student today, participating, staying engaged, and giving ${p.possAdj} best effort.`,
        (n,p) => `${n} has been showing incredible progress and consistency in the dojo lately, and today really showed it.`
      ],
      behavior: [
        (n,p) => `${n} showed excellent behavior today‚Äîrespectful, focused, and kind to others.`,
        (n,p) => `${n} was so well-behaved and set a great example for other Ninjas in the dojo today.`,
        (n,p) => `${n} helped keep the dojo a fun, positive space for everyone with ${p.possAdj} awesome behavior today.`
      ],
      helper: [
        (n,p) => `${n} helped another student in class today‚Äîsuch a kind and thoughtful moment of leadership. ü§ù`,
        (n,p) => `${n} went out of ${p.possAdj} way to support a fellow Ninja today, which really stood out to our team.`,
        (n,p) => `${n} showed great leadership and teamwork by helping other students during class today.`
      ],
      attendance: [
        (n,p) => `${n} has had fantastic attendance lately, and that consistency is really helping ${p.obj} grow.`,
        (n,p) => `${n} has been so committed to showing up regularly, and we‚Äôre seeing great progress because of it.`,
        (n,p) => `${n} is progressing quickly thanks to ${p.possAdj} strong and consistent attendance at Code Ninjas.`
      ],
      leadership: [
        (n,p) => `${n} showed strong leadership and teamwork in the dojo today‚Äîencouraging others and working really well with the group. üß†`,
        (n,p) => `${n} stepped up and demonstrated great leadership skills in class today.`,
        (n,p) => `${n} was a positive leader and role model in the dojo today, and we really appreciated ${p.possAdj} attitude and support of others.`
      ],
      birthday: [
        (n,p) => `${n} had such a fun birthday at the dojo today‚Äîwe loved celebrating with ${p.obj}! üéâ`,
        (n,p) => `We had a great time celebrating ${n}‚Äôs birthday at Code Ninjas today.`,
        (n,p) => `${n} brought such great energy to ${p.possAdj} birthday visit today and made the dojo feel extra festive. üéÇ`
      ]
    };

    const reasonLabels = {
      belt: "Belt-Up",
      project: "Cool Project",
      outstanding: "Outstanding Student",
      behavior: "Great Behavior",
      helper: "Helping Another Ninja",
      attendance: "Great Attendance",
      leadership: "Leadership & Teamwork",
      birthday: "Birthday Shoutout",
      tour: "Tour Follow-up",
      custom: "Custom Shoutout"
    };

    function randomFrom(arr){
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function buildCoreMessage(name, reason, customReason, senseiName, pronoun){
      const trimmedName = (name || "").trim();
      if(!trimmedName) return "";

      if(reason === "custom"){
        const detail = (customReason || "").trim() || "doing something awesome in the dojo today";
        return `${trimmedName} earned a special shout-out today for ${detail}. ‚ú®`;
      }

      if(reason === "tour"){
        const s = (senseiName || "").trim();
        if(s){
          return `${s} had such a fun time with ${trimmedName} during their tour today. We loved showing them around the dojo and talking about how everything works.`;
        }else{
          return `${trimmedName} had a really fun tour at the dojo today. We loved meeting them and showing what Code Ninjas is all about.`;
        }
      }

      const options = coreTemplates[reason];
      if(!options || !options.length) return "";
      return randomFrom(options)(trimmedName, pronoun);
    }

    function buildFullMessage(name, reason, customReason, senderName, senseiName, parentName, pronoun){
      const core = buildCoreMessage(name, reason, customReason, senseiName, pronoun);
      if(!core) return "";

      if(reason === "birthday"){
        return baseBirthdayMessage(name, parentName, core, senderName, pronoun);
      }
      if(reason === "tour"){
        return baseTourMessage(name, parentName, core, senderName, pronoun);
      }
      return baseStandardMessage(name, parentName, core, senderName, pronoun);
    }

    // ===== BANNERS / CLIPBOARD =====
    function showOk(msg){
      const el = document.getElementById("okBanner");
      el.textContent = msg || "Copied! You can paste this into your text app. üì≤";
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 3500);
    }

    function showErr(msg){
      const el = document.getElementById("errBanner");
      el.textContent = msg || "Something went wrong. Please try again.";
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 4000);
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }
    }

    // ===== IMAGE / CANVAS (TWO FRAMES + ZOOM/PAN) =====
    let userImage = null;

    let frameWideImage = null;
    let frameStoryImage = null;
    let frameWideLoaded = false;
    let frameStoryLoaded = false;

    let latestCoreMessage = "";
    let currentReason = "";
    let currentNinjaName = "";
    let latestImageGenerated = false; // both frames rendered

    const canvasWide = document.getElementById("shoutoutCanvasWide");
    const ctxWide = canvasWide.getContext("2d");

    const canvasStory = document.getElementById("shoutoutCanvasStory");
    const ctxStory = canvasStory.getContext("2d");

    function loadFrames(){
      frameWideImage = new Image();
      frameWideImage.onload = () => { frameWideLoaded = true; };
      frameWideImage.src = "ninja-shoutout-frame.png";

      frameStoryImage = new Image();
      frameStoryImage.onload = () => { frameStoryLoaded = true; };
      frameStoryImage.src = "Congratulations! (Your Story).png";
    }

    function handlePhotoFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const img = new Image();
        img.onload = function(){
          userImage = img;
          latestImageGenerated = false;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function drawCoverImage(img, ctx, width, height, zoomFactor, panX, panY){
      const iw = img.width;
      const ih = img.height;
      if(!iw || !ih) return;

      const baseScale = Math.max(width/iw, height/ih);
      const scale = baseScale * zoomFactor;

      const sw = iw*scale;
      const sh = ih*scale;

      // Allow up to ~30% shift of canvas size
      const maxShiftX = width*0.3;
      const maxShiftY = height*0.3;

      const shiftX = (panX/100)*maxShiftX;
      const shiftY = (panY/100)*maxShiftY;

      const sx = (width - sw)/2 + shiftX;
      const sy = (height - sh)/2 + shiftY;

      ctx.drawImage(img, sx, sy, sw, sh);
    }

    function renderShoutoutText(ctx, width, height, mode){
      let message = latestCoreMessage;
      if (!message) return;

      if (currentReason === "birthday") {
        const name = currentNinjaName || "your Ninja";
        const offerLine = `We loved celebrating ${name} today! 1+1 CREATE + Clubs bundle for $249.`;
        message = message + " " + offerLine;
      }

      let maxWidth, fontSize, lineHeight, marginX, marginY, bgX, bgY, bgWidth, bgHeight;

      if(mode === "wide"){
        maxWidth  = width * 0.38;
        fontSize  = Math.round(width * 0.028); // ~46 on 1650
        lineHeight = Math.round(fontSize * 1.25);
        marginX   = width * 0.06;
        marginY   = height * 0.08;
      }else{
        // story
        maxWidth  = width * 0.85;
        fontSize  = Math.round(width * 0.04);  // ~30 on 768
        lineHeight = Math.round(fontSize * 1.3);
        marginX   = width * 0.05;
        marginY   = height * 0.05;
      }

      ctx.font = `${fontSize}px system-ui, -apple-system, 'Segoe UI', sans-serif`;
      ctx.fillStyle = "#ffffff";
      ctx.textBaseline = "top";

      const words = message.split(/\s+/);
      let lines = [];
      let line = "";

      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + " ";
        if (ctx.measureText(testLine).width > maxWidth && n > 0) {
          lines.push(line);
          line = words[n] + " ";
        } else {
          line = testLine;
        }
      }
      if (line) lines.push(line);

      const textHeight = lines.length * lineHeight;
      bgWidth = maxWidth + 40;
      bgHeight = textHeight + lineHeight * 1.8;

      if(mode === "wide"){
        bgX = width - bgWidth - marginX;
      }else{
        bgX = (width - bgWidth)/2;
      }
      bgY = height - bgHeight - marginY;

      ctx.fillStyle = "rgba(0,0,0,0.45)";
      ctx.beginPath();
      if (ctx.roundRect) ctx.roundRect(bgX, bgY, bgWidth, bgHeight, 25);
      else ctx.rect(bgX, bgY, bgWidth, bgHeight);
      ctx.fill();

      ctx.fillStyle = "#ffffff";
      let textX = bgX + 20;
      let textY = bgY + 16;

      lines.forEach(l => {
        ctx.fillText(l.trim(), textX, textY);
        textY += lineHeight;
      });

      ctx.font = `${Math.round(fontSize * 0.9)}px system-ui, -apple-system, 'Segoe UI', sans-serif`;
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.fillText("Visit CodeNinjas.com to learn more!", textX, textY + 6);
    }

    function renderShoutoutImages(){
      if(!latestCoreMessage){
        showErr("Generate a shout-out first so we know what text to place on the images.");
        return;
      }
      if(!userImage){
        showErr("Please upload a Ninja photo first.");
        return;
      }
      if(!frameWideLoaded || !frameStoryLoaded){
        showErr("Frame images are still loading. Wait a moment and try again.");
        return;
      }

      const zoomSlider = document.getElementById("zoomSlider");
      const panXSlider = document.getElementById("panXSlider");
      const panYSlider = document.getElementById("panYSlider");

      const zoom = parseFloat(zoomSlider.value || "1");
      const panX = parseFloat(panXSlider.value || "0");
      const panY = parseFloat(panYSlider.value || "0");

      const ww = canvasWide.width;
      const wh = canvasWide.height;
      ctxWide.clearRect(0,0,ww,wh);
      drawCoverImage(userImage, ctxWide, ww, wh, zoom, panX, panY);
      ctxWide.drawImage(frameWideImage, 0, 0, ww, wh);
      renderShoutoutText(ctxWide, ww, wh, "wide");

      const sw = canvasStory.width;
      const sh = canvasStory.height;
      ctxStory.clearRect(0,0,sw,sh);
      drawCoverImage(userImage, ctxStory, sw, sh, zoom, panX, panY);
      ctxStory.drawImage(frameStoryImage, 0, 0, sw, sh);
      renderShoutoutText(ctxStory, sw, sh, "story");

      latestImageGenerated = true;
    }

    // ===== MAIN UI HOOKUP =====
    document.addEventListener("DOMContentLoaded", function(){
      loadFrames();

      const nameInput = document.getElementById("ninjaName");
      const parentInput = document.getElementById("parentName");
      const pronounSelect = document.getElementById("pronounSelect");
      const senderInput = document.getElementById("senderName");
      const customInput = document.getElementById("customReason");
      const senseiInput = document.getElementById("senseiName");
      const senseiRow = document.getElementById("senseiRow");
      const output = document.getElementById("messageOutput");
      const generateBtn = document.getElementById("generateBtn");
      const copyBtn = document.getElementById("copyBtn");
      const emailBtn = document.getElementById("emailBtn");
      const optionCards = document.querySelectorAll(".shoutout-option");
      const photoInput = document.getElementById("photoInput");
      const renderImageBtn = document.getElementById("renderImageBtn");
      const downloadWideBtn = document.getElementById("downloadWideBtn");
      const downloadStoryBtn = document.getElementById("downloadStoryBtn");

      const zoomSlider = document.getElementById("zoomSlider");
      const panXSlider = document.getElementById("panXSlider");
      const panYSlider = document.getElementById("panYSlider");
      const zoomLabel = document.getElementById("zoomLabel");
      const panXLabel = document.getElementById("panXLabel");
      const panYLabel = document.getElementById("panYLabel");

      const next1 = document.getElementById("next1");
      const back2 = document.getElementById("back2");
      const next2 = document.getElementById("next2");
      const back3 = document.getElementById("back3");

      let currentStep = 1;
      function showStep(step){
        document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
        const el = document.getElementById("step"+step);
        if(el) el.classList.add("active");
        currentStep = step;
      }

      function getSelectedReason(){
        const checked = document.querySelector('input[name="reason"]:checked');
        return checked ? checked.value : "";
      }

      function updateSelectionVisuals(){
        optionCards.forEach(card => {
          const input = card.querySelector("input");
          card.classList.toggle("selected", !!(input && input.checked));
        });

        const reason = getSelectedReason();
        if(reason === "tour"){
          senseiRow.style.display = "block";
        }else{
          senseiRow.style.display = "none";
        }
        updateStep1Next();
      }

      function updateStep1Next(){
        const hasName = !!nameInput.value.trim();
        const hasReason = !!getSelectedReason();
        next1.disabled = !(hasName && hasReason);
      }

      function updateStep2Next(){
        const hasText = !!(output.value || "").trim();
        next2.disabled = !hasText;
      }

      optionCards.forEach(card => {
        card.addEventListener("click", () => {
          const input = card.querySelector("input");
          if(input){
            input.checked = true;
            updateSelectionVisuals();
          }
        });
      });

      document.querySelectorAll('input[name="reason"]').forEach(i => {
        i.addEventListener("change", updateSelectionVisuals);
      });

      nameInput.addEventListener("input", updateStep1Next);

      // Step navigation
      next1.addEventListener("click", () => {
        showStep(2);
      });

      back2.addEventListener("click", () => {
        showStep(1);
      });

      next2.addEventListener("click", () => {
        showStep(3);
      });

      back3.addEventListener("click", () => {
        showStep(2);
      });

      // Generate + copy
      generateBtn.addEventListener("click", () => {
        const name = nameInput.value;
        const parentName = parentInput.value;
        const reason = getSelectedReason();
        const custom = customInput.value;
        const senderName = senderInput.value || "Marina";
        const senseiName = senseiInput.value;
        const pronounCode = pronounSelect.value;
        const pronoun = getPronouns(pronounCode);

        if(!name.trim()){
          showErr("Please enter the Ninja‚Äôs name first.");
          nameInput.focus();
          return;
        }
        if(!reason){
          showErr("Please choose what you‚Äôre shouting them out for.");
          showStep(1);
          return;
        }

        const core = buildCoreMessage(name, reason, custom, senseiName, pronoun);
        if(!core){
          showErr("Could not generate message. Try again.");
          return;
        }
        latestCoreMessage = core;
        currentReason = reason;
        currentNinjaName = (name || "").trim();

        const fullMessage = buildFullMessage(name, reason, custom, senderName, senseiName, parentName, pronoun);
        output.value = fullMessage;
        updateStep2Next();
        showOk("Shout-out generated!");
      });

      copyBtn.addEventListener("click", async () => {
        const text = (output.value || "").trim();
        if(!text){
          showErr("Generate a shout-out first, then copy it.");
          return;
        }
        const ok = await copyToClipboard(text);
        if(ok){
          showOk("Copied! Paste into your text app or email. üì≤");
        }else{
          showErr("Couldn‚Äôt copy automatically. Please select and copy manually.");
        }
      });

      photoInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if(file){
          handlePhotoFile(file);
          latestImageGenerated = false;
          showOk("Photo loaded! Use the sliders, then click ‚ÄúGenerate both images‚Äù.");
        }
      });

      // Slider labels + live re-render when adjusted
      function refreshSliderLabels(){
        zoomLabel.textContent = `${parseFloat(zoomSlider.value).toFixed(2)}√ó`;
        panXLabel.textContent = panXSlider.value;
        panYLabel.textContent = panYSlider.value;
      }
      [zoomSlider, panXSlider, panYSlider].forEach(sl => {
        sl.addEventListener("input", () => {
          refreshSliderLabels();
          if(userImage && latestCoreMessage){
            renderShoutoutImages();
            downloadWideBtn.disabled = false;
            downloadStoryBtn.disabled = false;
          }
        });
      });
      refreshSliderLabels();

      renderImageBtn.addEventListener("click", () => {
        renderShoutoutImages();
        downloadWideBtn.disabled = false;
        downloadStoryBtn.disabled = false;
      });

      downloadWideBtn.addEventListener("click", () => {
        const dataUrl = canvasWide.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = "ninja-shoutout-landscape.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showOk("Landscape image downloaded. You can attach it to your email or text.");
      });

      downloadStoryBtn.addEventListener("click", () => {
        const dataUrl = canvasStory.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = "ninja-shoutout-story.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showOk("Story image downloaded. Perfect for social media stories!");
      });

      emailBtn.addEventListener("click", () => {
        const text = (output.value || "").trim();
        const ninjaName = (nameInput.value || "").trim();
        const reason = currentReason || getSelectedReason();

        if(!text){
          showErr("Generate the shout-out text first (Step 2) before emailing.");
          return;
        }
        if(!latestImageGenerated){
          showErr("Please generate the images first, then download them so you can attach them to the email.");
          return;
        }

        const subjectParts = ["Ninja Shoutout"];
        if(ninjaName) subjectParts.push(ninjaName);
        const reasonLabel = reasonLabels[reason] || "";
        if(reasonLabel) subjectParts.push(reasonLabel);
        const subject = subjectParts.join(" ‚Äì ");

        const body =
          text +
          "\n\n---\n" +
          "Please see attached image files (ninja-shoutout-landscape.png and/or ninja-shoutout-story.png) for the shout-out pictures.\n" +
          "(Generated with Ninja Shout-Out Builder)";

        const mailto = `mailto:coopercityfl@codeninjas.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
      });

      // init
      showStep(1);
      updateStep1Next();
      updateStep2Next();
    });
  </script>
</body>
</html>
