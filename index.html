<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ninja Shoutout</title>

  <!-- iPad / iPhone web app meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Ninja Shoutout">
  <link rel="apple-touch-icon" href="icon-180.png">

  <style>
    :root{
      --bg1:#0ea5e9;
      --bg2:#2563eb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#2563eb;
      --brand-soft:#dbeafe;
      --border:#e5e7eb;
      --radius:18px;
      --shadow:0 14px 40px rgba(15,23,42,.18),0 3px 10px rgba(15,23,42,.10);
      --ok:#22c55e;
      --error:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    html,body{
      min-height:100vh;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment:fixed;
    }

    body{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
    }

    .wrap{
      width:100%;
      max-width:920px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    header{
      text-align:center;
      color:#e5edff;
    }
    header .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    header img.logo{
      height:40px;
      width:auto;
      filter:drop-shadow(0 1px 2px rgba(15,23,42,.35));
    }
    header h1{
      margin:10px 0 4px;
      font-size:clamp(22px,4vw,32px);
      font-weight:800;
    }
    header p{
      margin:0;
      font-size:14px;
      color:#bfdbfe;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter:saturate(1.2) blur(4px);
    }

    /* New: iPad-friendly stepper */
    .stepper{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:#0f172a;
      font-size:12px;
      font-weight:700;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:999px;background:#cbd5e1;
    }
    .pill.active{
      background:var(--brand-soft);
      border-color:rgba(37,99,235,.35);
    }
    .pill.active .dot{ background: var(--brand); }

    .step-header{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .step-number{
      width:28px;
      height:28px;
      border-radius:999px;
      background:var(--brand-soft);
      color:var(--brand);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:13px;
      flex-shrink:0;
    }
    .step-header h2{
      margin:0;
      font-size:18px;
      font-weight:800;
      color:#0f172a;
    }
    .step-description{
      margin:2px 0 0;
      font-size:13px;
      color:var(--muted);
    }

    .question-container{
      margin:8px 0 12px;
    }

    label.field-label{
      display:block;
      font-size:13px;
      font-weight:700;
      color:#0f172a;
      margin-bottom:6px;
    }

    input[type="text"],
    input[type="file"],
    textarea,
    select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:15px; /* iPad-friendly */
      font-family:inherit;
      transition:all .18s ease;
      background:#f8fafc;
      color:var(--ink);
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 2px rgba(37,99,235,.14);
      background:#ffffff;
    }

    input[type="file"]{
      padding:10px 10px;
      background:#f9fafb;
    }

    textarea{
      min-height:170px;
      resize:vertical;
      line-height:1.5;
      font-size:15px;
    }

    .options-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:10px;
      margin-top:6px;
    }

    .shoutout-option{
      display:block;
      border-radius:14px;
      padding:12px;
      border:1px solid var(--border);
      cursor:pointer;
      transition:all .18s ease;
      background:#ffffff;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .shoutout-option:hover{
      border-color:var(--brand);
      box-shadow:0 6px 18px rgba(15,23,42,.08);
      transform:translateY(-1px);
    }

    .shoutout-option input{ display:none; }

    .shoutout-option.selected{
      border-color:var(--brand);
      background:var(--brand-soft);
    }

    .option-content{
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-size:14px;
      color:#0f172a;
    }
    .option-icon{
      font-size:20px;
      line-height:1;
      margin-top:1px;
    }
    .option-text{
      font-weight:800;
    }
    .option-sub{
      font-size:12px;
      color:#6b7280;
      margin-top:3px;
      font-weight:500;
    }

    .inline-note{
      font-size:12px;
      color:#6b7280;
      padding:8px 10px;
      border-radius:10px;
      background:#eff6ff;
      margin-top:8px;
    }

    .btn{
      appearance:none;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:46px; /* iPad tap target */
      white-space:nowrap;
      transition:all .18s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#ffffff;
      box-shadow:0 6px 18px rgba(37,99,235,.30);
    }
    .btn.ghost{
      background:#ffffff;
      color:#0f172a;
    }
    .btn:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 8px 22px rgba(15,23,42,.14);
    }
    .btn.primary:hover:not(:disabled){
      background:#1d4ed8;
      border-color:#1d4ed8;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .actions-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      margin-top:14px;
    }
    .actions-row .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }

    .banner{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      font-weight:700;
    }
    .banner.ok{
      background:rgba(22,163,74,.08);
      color:#15803d;
      border:1px solid rgba(22,163,74,.35);
    }
    .banner.error{
      background:rgba(239,68,68,.06);
      color:#b91c1c;
      border:1px solid rgba(239,68,68,.35);
    }

    .canvas-wrap{
      margin-top:12px;
      border-radius:14px;
      border:1px dashed var(--border);
      padding:10px;
      background:#f8fafc;
    }
    .canvas-inner{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:flex-start;
    }
    .canvas-row{ width:100%; }

    canvas{
      width:100%;
      max-width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      background:#020617;
      display:block;
      touch-action:none;
      cursor:grab;
    }
    canvas:active{ cursor:grabbing; }

    .photo-controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .slider-field{
      font-size:12px;
      color:#374151;
    }
    .slider-field label{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      font-weight:800;
    }
    .slider-field input[type="range"]{
      width:100%;
    }

    /* Step system */
    .step{
      display:none;
      animation:fade .22s ease;
    }
    .step.active{ display:block; }
    @keyframes fade{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:translateY(0);}
    }

    /* iPad: keep buttons full width-ish on small screens */
    @media (max-width:720px){
      .actions-row{
        flex-direction:column;
        align-items:stretch;
      }
      .actions-row .right{
        width:100%;
        justify-content:stretch;
      }
      .actions-row .btn{
        width:100%;
      }
    }

    /* NEW: Subject preview chip */
    .subject-preview{
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#ffffff;
    }
    .subject-preview .label{
      font-size:12px;
      color:#64748b;
      font-weight:800;
      margin-bottom:4px;
    }
    .subject-preview .value{
      font-size:14px;
      font-weight:900;
      color:#0f172a;
      word-break:break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo" src="https://www.codeninjas.com/hubfs/Group%201.svg" alt="Code Ninjas logo" onerror="this.style.display='none'">
      </div>
      <h1>Ninja Shout-Out Builder</h1>
      <p>Tap through the steps (iPad-friendly) to generate a message + two shout-out images.</p>
    </header>

    <section class="card" aria-live="polite">
      <!-- iPad-friendly stepper -->
      <div class="stepper" id="stepper">
        <div class="pill active" data-step="1"><span class="dot"></span> Center</div>
        <div class="pill" data-step="2"><span class="dot"></span> Ninja</div>
        <div class="pill" data-step="3"><span class="dot"></span> Shout-out</div>
        <div class="pill" data-step="4"><span class="dot"></span> Message</div>
        <div class="pill" data-step="5"><span class="dot"></span> Images</div>
      </div>

      <!-- STEP 1: CENTER -->
      <div class="step active" id="step1">
        <div class="step-header">
          <div class="step-number">1</div>
          <div>
            <h2>Choose your center</h2>
            <p class="step-description">This sets the center email automatically for the ‚ÄúEmail to center‚Äù button.</p>
          </div>
        </div>

        <div class="question-container">
          <label for="centerSelect" class="field-label">Center</label>
          <select id="centerSelect">
            <option value="cooper">Cooper City</option>
            <option value="aventura">Aventura</option>
            <option value="weston">Weston</option>
          </select>
          <div class="inline-note" id="centerEmailNote">
            Center email: <strong id="centerEmailDisplay">coopercityfl@codeninjas.com</strong>
          </div>
        </div>

        <div class="actions-row">
          <div></div>
          <div class="right">
            <button class="btn primary" type="button" id="next1" disabled>
              Next ‚ñ∂
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 2: NINJA -->
      <div class="step" id="step2">
        <div class="step-header">
          <div class="step-number">2</div>
          <div>
            <h2>Ninja details</h2>
            <p class="step-description">Name + parent greeting + pronouns + who‚Äôs sending the message.</p>
          </div>
        </div>

        <div class="question-container">
          <label for="ninjaName" class="field-label">Ninja‚Äôs name</label>
          <input id="ninjaName" type="text" placeholder="e.g., Alex, Sophia, Ethan" autocomplete="off" />
        </div>

        <div class="question-container">
          <label for="parentName" class="field-label">Parent name (optional)</label>
          <input id="parentName" type="text" placeholder="e.g., Emma‚Äôs mom, Sarah" autocomplete="off" />
          <div class="inline-note">If blank, it will start with ‚ÄúHi there,‚Äù.</div>
        </div>

        <div class="question-container">
          <label for="pronounSelect" class="field-label">Ninja pronouns</label>
          <select id="pronounSelect">
            <option value="they">They / their (default)</option>
            <option value="he">He / his</option>
            <option value="she">She / her</option>
          </select>
        </div>

        <div class="question-container">
          <label for="senderName" class="field-label">Sender name (who is texting?)</label>
          <input id="senderName" type="text" placeholder="e.g., Marina" value="Marina" autocomplete="off" />
        </div>

        <div class="actions-row">
          <button class="btn ghost" type="button" id="back2">‚óÄ Back</button>
          <div class="right">
            <button class="btn primary" type="button" id="next2" disabled>Next ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- STEP 3: SHOUT-OUT TYPE -->
      <div class="step" id="step3">
        <div class="step-header">
          <div class="step-number">3</div>
          <div>
            <h2>What are we shouting them out for?</h2>
            <p class="step-description">Pick a reason. ‚ÄúTour‚Äù shows the Sensei field. ‚ÄúCustom‚Äù lets you type a reason.</p>
          </div>
        </div>

        <div class="question-container">
          <div class="options-grid" id="shoutoutGrid">
            <label class="shoutout-option">
              <input type="radio" name="reason" value="belt">
              <div class="option-content">
                <div class="option-icon">üéâ</div>
                <div>
                  <div class="option-text">Belt-up celebration</div>
                  <div class="option-sub">Leveling up their belt in the dojo.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="project">
              <div class="option-content">
                <div class="option-icon">üíª</div>
                <div>
                  <div class="option-text">Cool project</div>
                  <div class="option-sub">Finished something awesome in class.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="outstanding">
              <div class="option-content">
                <div class="option-icon">‚≠ê</div>
                <div>
                  <div class="option-text">Outstanding student</div>
                  <div class="option-sub">Focus, effort, and great attitude.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="behavior">
              <div class="option-content">
                <div class="option-icon">üòä</div>
                <div>
                  <div class="option-text">Well-behaved</div>
                  <div class="option-sub">Respectful, kind, a great example.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="helper">
              <div class="option-content">
                <div class="option-icon">ü§ù</div>
                <div>
                  <div class="option-text">Helped another student</div>
                  <div class="option-sub">Leadership + teamwork moment.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="attendance">
              <div class="option-content">
                <div class="option-icon">üìÖ</div>
                <div>
                  <div class="option-text">Great attendance</div>
                  <div class="option-sub">Showing up consistently to level up.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="leadership">
              <div class="option-content">
                <div class="option-icon">üß†</div>
                <div>
                  <div class="option-text">Leadership / teamwork</div>
                  <div class="option-sub">Encouraging others + great energy.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="birthday">
              <div class="option-content">
                <div class="option-icon">üéÇ</div>
                <div>
                  <div class="option-text">Birthday shout-out</div>
                  <div class="option-sub">Includes the $249 1+1 bundle mention.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="tour">
              <div class="option-content">
                <div class="option-icon">üèØ</div>
                <div>
                  <div class="option-text">Tour follow-up</div>
                  <div class="option-sub">Invite them back after touring.</div>
                </div>
              </div>
            </label>

            <label class="shoutout-option">
              <input type="radio" name="reason" value="custom">
              <div class="option-content">
                <div class="option-icon">‚ú®</div>
                <div>
                  <div class="option-text">Custom shout-out</div>
                  <div class="option-sub">Type your own reason (focus, kindness, etc.).</div>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="question-container">
          <label for="customReason" class="field-label">If custom, what are we celebrating? (optional)</label>
          <input id="customReason" type="text" placeholder='e.g., "amazing focus today", "being so kind to others"' autocomplete="off" />
        </div>

        <div class="question-container" id="senseiRow" style="display:none;">
          <label for="senseiName" class="field-label">Sensei name (for tour texts)</label>
          <input id="senseiName" type="text" placeholder='e.g., "Sensei Alex"' autocomplete="off" />
        </div>

        <div class="actions-row">
          <button class="btn ghost" type="button" id="back3">‚óÄ Back</button>
          <div class="right">
            <button class="btn primary" type="button" id="next3" disabled>Next ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- STEP 4: MESSAGE + SUBJECT PREVIEW -->
      <div class="step" id="step4">
        <div class="step-header" style="margin-top:0;">
          <div class="step-number">4</div>
          <div>
            <h2>Generate message</h2>
            <p class="step-description">Pick a subject style, generate the message, then copy or continue to images.</p>
          </div>
        </div>

        <div class="question-container">
          <label for="subjectStyle" class="field-label">Email subject style</label>
          <select id="subjectStyle">
            <option value="simple">Simple</option>
            <option value="warm">Warm</option>
            <option value="hype">Hype</option>
          </select>

          <div class="subject-preview">
            <div class="label">Subject preview</div>
            <div class="value" id="subjectPreview">Ninja Shoutout ‚Äì (generate to preview)</div>
          </div>
        </div>

        <div class="question-container">
          <label for="messageOutput" class="field-label">Message to parent (SMS or email)</label>
          <textarea id="messageOutput" placeholder="Tap ‚ÄúGenerate‚Äù to build your message." readonly></textarea>
        </div>

        <div class="actions-row">
          <button class="btn ghost" type="button" id="back4">‚óÄ Back</button>
          <div class="right">
            <button class="btn ghost" type="button" id="generateBtn">‚ú® Generate</button>
            <button class="btn primary" type="button" id="copyBtn">üìã Copy message</button>
            <button class="btn" type="button" id="next4" disabled>Next ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- STEP 5: IMAGES + EMAIL -->
      <div class="step" id="step5">
        <div class="step-header" style="margin-top:0;">
          <div class="step-number">5</div>
          <div>
            <h2>Shout-out pictures</h2>
            <p class="step-description">
              Upload a photo. Drag on the canvas to reposition, scroll to zoom, or use sliders. Then download or email to the center.
            </p>
          </div>
        </div>

        <div class="question-container">
          <label for="photoInput" class="field-label">Ninja photo</label>
          <input id="photoInput" type="file" accept="image/*" />
          <div class="inline-note">
            Put <strong>ninja-shoutout-frame.png</strong> (landscape) and <strong>Congratulations! (Your Story).png</strong> (vertical) in the same folder as this HTML file.
          </div>
        </div>

        <div class="photo-controls">
          <div class="slider-field">
            <label for="zoomSlider"><span>Zoom</span><span id="zoomLabel">1.00√ó</span></label>
            <input id="zoomSlider" type="range" min="0.6" max="2.0" step="0.02" value="1.0" />
          </div>
          <div class="slider-field">
            <label for="panXSlider"><span>Horizontal</span><span id="panXLabel">0</span></label>
            <input id="panXSlider" type="range" min="-100" max="100" step="1" value="0" />
          </div>
          <div class="slider-field">
            <label for="panYSlider"><span>Vertical</span><span id="panYLabel">0</span></label>
            <input id="panYSlider" type="range" min="-100" max="100" step="1" value="0" />
          </div>
        </div>

        <div class="canvas-wrap">
          <div class="canvas-inner">
            <div class="canvas-row">
              <label class="field-label">Landscape frame</label>
              <canvas id="shoutoutCanvasWide" width="1650" height="1275"></canvas>
            </div>

            <div class="canvas-row">
              <label class="field-label">Vertical story frame</label>
              <canvas id="shoutoutCanvasStory" width="768" height="1365"></canvas>
            </div>

            <div class="actions-row" style="justify-content:space-between;margin-top:6px;">
              <button class="btn ghost" type="button" id="back5">‚óÄ Back</button>
              <div class="right">
                <button class="btn ghost" type="button" id="renderImageBtn">üñº Generate images</button>
                <button class="btn" type="button" id="downloadWideBtn" disabled>‚¨á Download landscape</button>
                <button class="btn" type="button" id="downloadStoryBtn" disabled>‚¨á Download story</button>
                <button class="btn primary" type="button" id="emailBtn">‚úâÔ∏è Email to center</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="okBanner" class="banner ok"></div>
      <div id="errBanner" class="banner error"></div>
    </section>
  </div>

  <script>
    // ===== PRONOUNS =====
    function getPronouns(code){
      let p;
      if(code === "he"){
        p = {subj:"he", obj:"him", possAdj:"his", possPron:"his", refl:"himself"};
      } else if(code === "she"){
        p = {subj:"she", obj:"her", possAdj:"her", possPron:"hers", refl:"herself"};
      } else {
        p = {subj:"they", obj:"them", possAdj:"their", possPron:"theirs", refl:"themselves"};
      }
      const cap = s => s.charAt(0).toUpperCase() + s.slice(1);
      return { ...p, subjCap: cap(p.subj), objCap: cap(p.obj), possAdjCap: cap(p.possAdj) };
    }

    // ===== CENTER MAP (auto email) =====
    const centerMap = {
      cooper:  { label: "Cooper City", email: "coopercityfl@codeninjas.com", centerName: "Code Ninjas Cooper City" },
      aventura:{ label: "Aventura",    email: "aventurafl@codeninjas.com",   centerName: "Code Ninjas Aventura" },
      weston:  { label: "Weston",      email: "westonfl@codeninjas.com",     centerName: "Code Ninjas Weston" }
    };

    function getCenter(){
      const key = document.getElementById("centerSelect")?.value || "cooper";
      return centerMap[key] || centerMap.cooper;
    }

    // ===== TEXT TEMPLATES (no learn-more/referral/QR) =====
    function baseStandardMessage(ninjaName, parentName, core, senderName, centerName){
      const sender = (senderName || "Marina").trim();
      const child = (ninjaName || "your Ninja").trim();
      const center = (centerName || "Code Ninjas").trim();
      const parentLine = parentName && parentName.trim()
        ? `Hi ${parentName.trim()},`
        : "Hi there,";

      return (
        `${parentLine}\n` +
        `This is ${sender} from ${center}.\n\n` +
        `I just wanted to share how great ${child} was today. ${core}\n\n` +
        `I grabbed a quick photo of ${child} in the dojo and thought you might like it. If you‚Äôd like to share it with friends or family, feel free. üòä\n\n` +
        `Thanks for being part of our dojo family! üíô`
      );
    }

    function baseBirthdayMessage(ninjaName, parentName, core, senderName, pronoun, centerName){
      const sender = (senderName || "Marina").trim();
      const child = (ninjaName || "your Ninja").trim();
      const center = (centerName || "Code Ninjas").trim();
      const parentLine = parentName && parentName.trim()
        ? `Hi ${parentName.trim()},`
        : "Hi there,";

      return (
        `${parentLine}\n` +
        `This is ${sender} from ${center}.\n\n` +
        `We loved celebrating ${child}‚Äôs birthday in the dojo today! ${core}\n\n` +
        `We snapped a quick picture of ${child} in action and thought you might like to have it. Feel free to share it with friends or family if you‚Äôd like. üéÇ\n\n` +
        `Since it was ${pronoun.possAdj} special day, we‚Äôre also running a birthday special: our 1+1 CREATE + Clubs bundle for a discounted rate of $249. If you‚Äôd ever like more details or want to check if it‚Äôs a good fit, I‚Äôm happy to share.\n\n` +
        `Thanks for letting us be part of ${child}‚Äôs day! üíô`
      );
    }

    function baseTourMessage(ninjaName, parentName, core, senderName, centerName){
      const sender = (senderName || "Marina").trim();
      const center = (centerName || "Code Ninjas").trim();
      const parentLine = parentName && parentName.trim()
        ? `Hi ${parentName.trim()},`
        : "Hi there,";

      return (
        `${parentLine}\n` +
        `This is ${sender} from ${center}.\n\n` +
        `${core}\n\n` +
        `We grabbed a quick photo from the tour and thought you might like it. üòä If you‚Äôd like to share it with friends or family, go for it.\n\n` +
        `Whenever you‚Äôre ready to get started, you can use code TOUR for no enrollment fee for up to two weeks. No pressure at all‚Äîjust wanted to pass the option along.\n\n` +
        `Thanks again for stopping by the dojo! üíô`
      );
    }

    const coreTemplates = {
      belt: [
        (n,p) => `${n} leveled up ${p.possAdj} belt today! ${p.subjCap} worked really hard and it paid off in the dojo. üôå`,
        (n,p) => `${n} earned a new belt today and ${p.possAdj} consistency in class is really starting to shine. We were all proud of ${p.obj}!`,
        (n,p) => `${n} crushed it and ranked up ${p.possAdj} belt today‚Äîsuch a great example of sticking with a challenge.`
      ],
      project: [
        (n,p) => `${n} built a really awesome coding project today! üíª ${p.subjCap} showed a ton of creativity and problem-solving.`,
        (n,p) => `${n} completed an impressive project today and stayed focused from start to finish.`,
        (n,p) => `${n} showed strong skills and creativity today with a very cool project in class.`
      ],
      outstanding: [
        (n,p) => `${n} stood out as an outstanding Ninja today‚Äîgreat focus, effort, and attitude the whole time. ‚≠ê`,
        (n,p) => `${n} was an exceptional student today, participating, staying engaged, and giving ${p.possAdj} best effort.`,
        (n,p) => `${n} has been showing incredible progress and consistency in the dojo lately, and today really showed it.`
      ],
      behavior: [
        (n,p) => `${n} showed excellent behavior today‚Äîrespectful, focused, and kind to others.`,
        (n,p) => `${n} was so well-behaved and set a great example for other Ninjas in the dojo today.`,
        (n,p) => `${n} helped keep the dojo a fun, positive space for everyone with ${p.possAdj} awesome behavior today.`
      ],
      helper: [
        (n,p) => `${n} helped another student in class today‚Äîsuch a kind and thoughtful moment of leadership. ü§ù`,
        (n,p) => `${n} went out of ${p.possAdj} way to support a fellow Ninja today, which really stood out to our team.`,
        (n,p) => `${n} showed great leadership and teamwork by helping other students during class today.`
      ],
      attendance: [
        (n,p) => `${n} has had fantastic attendance lately, and that consistency is really helping ${p.obj} grow.`,
        (n,p) => `${n} has been so committed to showing up regularly, and we‚Äôre seeing great progress because of it.`,
        (n,p) => `${n} is progressing quickly thanks to ${p.possAdj} strong and consistent attendance at Code Ninjas.`
      ],
      leadership: [
        (n,p) => `${n} showed strong leadership and teamwork in the dojo today‚Äîencouraging others and working really well with the group. üß†`,
        (n,p) => `${n} stepped up and demonstrated great leadership skills in class today.`,
        (n,p) => `${n} was a positive leader and role model in the dojo today, and we really appreciated ${p.possAdj} attitude and support of others.`
      ],
      birthday: [
        (n,p) => `${n} had such a fun birthday at the dojo today‚Äîwe loved celebrating with ${p.obj}! üéâ`,
        (n,p) => `We had a great time celebrating ${n}‚Äôs birthday at Code Ninjas today.`,
        (n,p) => `${n} brought such great energy to ${p.possAdj} birthday visit today and made the dojo feel extra festive. üéÇ`
      ]
    };

    const reasonLabels = {
      belt: "Belt-Up",
      project: "Cool Project",
      outstanding: "Outstanding Student",
      behavior: "Great Behavior",
      helper: "Helping Another Ninja",
      attendance: "Great Attendance",
      leadership: "Leadership & Teamwork",
      birthday: "Birthday Shoutout",
      tour: "Tour Follow-up",
      custom: "Custom Shoutout"
    };

    function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function buildCoreMessage(name, reason, customReason, senseiName, pronoun){
      const trimmedName = (name || "").trim();
      if(!trimmedName) return "";

      if(reason === "custom"){
        const detail = (customReason || "").trim() || "doing something awesome in the dojo today";
        return `${trimmedName} earned a special shout-out today for ${detail}. ‚ú®`;
      }

      if(reason === "tour"){
        const s = (senseiName || "").trim();
        if(s){
          return `${s} had such a fun time with ${trimmedName} during their tour today. We loved showing them around the dojo and talking about how everything works.`;
        }
        return `${trimmedName} had a really fun tour at the dojo today. We loved meeting them and showing what Code Ninjas is all about.`;
      }

      const options = coreTemplates[reason];
      if(!options || !options.length) return "";
      return randomFrom(options)(trimmedName, pronoun);
    }

    function buildFullMessage(name, reason, customReason, senderName, senseiName, parentName, pronoun, centerName){
      const core = buildCoreMessage(name, reason, customReason, senseiName, pronoun);
      if(!core) return "";

      if(reason === "birthday"){
        return baseBirthdayMessage(name, parentName, core, senderName, pronoun, centerName);
      }
      if(reason === "tour"){
        return baseTourMessage(name, parentName, core, senderName, centerName);
      }
      return baseStandardMessage(name, parentName, core, senderName, centerName);
    }

    // ===== SUBJECT LINE GENERATION + PREVIEW =====
    function buildEmailSubject(style, ninjaName, reason, centerLabel){
      const n = (ninjaName || "").trim();
      const r = reasonLabels[reason] || "Shoutout";
      const c = (centerLabel || "Center").trim();

      const base = n ? `Ninja Shoutout ‚Äì ${n} ‚Äì ${r}` : `Ninja Shoutout ‚Äì ${r}`;
      if(style === "warm"){
        return n ? `So proud of ${n}! ‚Äì ${r} ü•∑üíô (${c})` : `Ninja Shoutout ü•∑üíô (${c})`;
      }
      if(style === "hype"){
        return n ? `LEVEL UP! ${n} ‚Äì ${r} üéâüî• (${c})` : `LEVEL UP! Ninja Shoutout üéâüî• (${c})`;
      }
      return n ? `${base} (${c})` : `${base} (${c})`;
    }

    // ===== BANNERS / CLIPBOARD =====
    function showOk(msg){
      const el = document.getElementById("okBanner");
      el.textContent = msg || "Done!";
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 3200);
    }

    function showErr(msg){
      const el = document.getElementById("errBanner");
      el.textContent = msg || "Something went wrong. Please try again.";
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 4000);
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }
    }

    // ===== IMAGE / CANVAS (TWO FRAMES + ZOOM/PAN + DRAG) =====
    let userImage = null;
    let frameWideImage = null;
    let frameStoryImage = null;
    let frameWideLoaded = false;
    let frameStoryLoaded = false;

    let latestCoreMessage = "";
    let currentReason = "";
    let currentNinjaName = "";
    let latestImageGenerated = false;

    const canvasWide = document.getElementById("shoutoutCanvasWide");
    const ctxWide = canvasWide.getContext("2d");

    const canvasStory = document.getElementById("shoutoutCanvasStory");
    const ctxStory = canvasStory.getContext("2d");

    function loadFrames(){
      frameWideImage = new Image();
      frameWideImage.onload = () => { frameWideLoaded = true; };
      frameWideImage.src = "ninja-shoutout-frame.png";

      frameStoryImage = new Image();
      frameStoryImage.onload = () => { frameStoryLoaded = true; };
      frameStoryImage.src = "Congratulations! (Your Story).png";
    }

    function handlePhotoFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const img = new Image();
        img.onload = function(){
          userImage = img;
          latestImageGenerated = false;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function drawCoverImage(img, ctx, width, height, zoomFactor, panX, panY){
      const iw = img.width;
      const ih = img.height;
      if(!iw || !ih) return;

      const baseScale = Math.max(width/iw, height/ih);
      const scale = baseScale * zoomFactor;

      const sw = iw*scale;
      const sh = ih*scale;

      const maxShiftX = width*0.3;
      const maxShiftY = height*0.3;

      const shiftX = (panX/100)*maxShiftX;
      const shiftY = (panY/100)*maxShiftY;

      const sx = (width - sw)/2 + shiftX;
      const sy = (height - sh)/2 + shiftY;

      ctx.drawImage(img, sx, sy, sw, sh);
    }

    // Auto-fit bubble text (no ‚Äúlearn more‚Äù line)
    function renderShoutoutText(ctx, width, height, mode){
      let message = latestCoreMessage;
      if (!message) return;

      if (currentReason === "birthday") {
        const name = currentNinjaName || "your Ninja";
        const offerLine = `We loved celebrating ${name} today! 1+1 CREATE + Clubs bundle for $249.`;
        message = message + " " + offerLine;
      }

      let maxWidth, marginX, marginY, fontSizeStart, minFont, lineHeightMult, maxBgHeight;

      if(mode === "wide"){
        maxWidth = width * 0.38;
        marginX = width * 0.06;
        marginY = height * 0.08;
        fontSizeStart = Math.round(width * 0.028);
        minFont = 22;
        lineHeightMult = 1.25;
        maxBgHeight = height * 0.45;
      }else{
        maxWidth = width * 0.85;
        marginX = width * 0.05;
        marginY = height * 0.05;
        fontSizeStart = Math.round(width * 0.04);
        minFont = 18;
        lineHeightMult = 1.3;
        maxBgHeight = height * 0.38;
      }

      function wrapLines(fontSize){
        ctx.font = `${fontSize}px system-ui, -apple-system, 'Segoe UI', sans-serif`;
        const words = message.split(/\s+/);
        let lines = [];
        let line = "";

        for (let i = 0; i < words.length; i++) {
          const testLine = line + words[i] + " ";
          if (ctx.measureText(testLine).width > maxWidth && i > 0) {
            lines.push(line.trim());
            line = words[i] + " ";
          } else {
            line = testLine;
          }
        }
        if (line.trim()) lines.push(line.trim());
        return lines;
      }

      let fontSize = fontSizeStart;
      let lines = wrapLines(fontSize);
      let lineHeight = Math.round(fontSize * lineHeightMult);

      while(fontSize > minFont){
        const textHeight = lines.length * lineHeight;
        const bgHeight = textHeight + lineHeight * 1.6;
        if(bgHeight <= maxBgHeight) break;
        fontSize -= 2;
        lines = wrapLines(fontSize);
        lineHeight = Math.round(fontSize * lineHeightMult);
      }

      const textHeight = lines.length * lineHeight;
      const bgWidth = maxWidth + 40;
      const bgHeight = Math.min(textHeight + lineHeight * 1.6, maxBgHeight);

      let bgX, bgY;
      if(mode === "wide"){
        bgX = width - bgWidth - marginX;
      }else{
        bgX = (width - bgWidth)/2;
      }
      bgY = height - bgHeight - marginY;

      // Bubble
      ctx.fillStyle = "rgba(0,0,0,0.45)";
      ctx.beginPath();
      if (ctx.roundRect) ctx.roundRect(bgX, bgY, bgWidth, bgHeight, 25);
      else ctx.rect(bgX, bgY, bgWidth, bgHeight);
      ctx.fill();

      // Text
      ctx.textBaseline = "top";
      ctx.fillStyle = "#ffffff";
      ctx.font = `${fontSize}px system-ui, -apple-system, 'Segoe UI', sans-serif`;

      const textX = bgX + 20;
      let textY = bgY + 14;

      const maxLines = Math.floor((bgHeight - 24) / lineHeight);
      const safeLines = lines.slice(0, Math.max(1, maxLines));

      safeLines.forEach(l => {
        ctx.fillText(l, textX, textY);
        textY += lineHeight;
      });
    }

    function renderShoutoutImages(){
      if(!latestCoreMessage){
        showErr("Generate the shout-out first (Step 4) so we know what text to place on the images.");
        return;
      }
      if(!userImage){
        showErr("Please upload a Ninja photo first.");
        return;
      }
      if(!frameWideLoaded || !frameStoryLoaded){
        showErr("Frame images are still loading. Wait a moment and try again.");
        return;
      }

      const zoom = parseFloat(document.getElementById("zoomSlider").value || "1");
      const panX = parseFloat(document.getElementById("panXSlider").value || "0");
      const panY = parseFloat(document.getElementById("panYSlider").value || "0");

      const ww = canvasWide.width, wh = canvasWide.height;
      ctxWide.clearRect(0,0,ww,wh);
      drawCoverImage(userImage, ctxWide, ww, wh, zoom, panX, panY);
      ctxWide.drawImage(frameWideImage, 0, 0, ww, wh);
      renderShoutoutText(ctxWide, ww, wh, "wide");

      const sw = canvasStory.width, sh = canvasStory.height;
      ctxStory.clearRect(0,0,sw,sh);
      drawCoverImage(userImage, ctxStory, sw, sh, zoom, panX, panY);
      ctxStory.drawImage(frameStoryImage, 0, 0, sw, sh);
      renderShoutoutText(ctxStory, sw, sh, "story");

      latestImageGenerated = true;
    }

    // ===== MAIN UI =====
    document.addEventListener("DOMContentLoaded", function(){
      loadFrames();

      // Elements
      const stepper = document.getElementById("stepper");

      const centerSelect = document.getElementById("centerSelect");
      const centerEmailDisplay = document.getElementById("centerEmailDisplay");

      const nameInput = document.getElementById("ninjaName");
      const parentInput = document.getElementById("parentName");
      const pronounSelect = document.getElementById("pronounSelect");
      const senderInput = document.getElementById("senderName");

      const customInput = document.getElementById("customReason");
      const senseiInput = document.getElementById("senseiName");
      const senseiRow = document.getElementById("senseiRow");
      const optionCards = document.querySelectorAll(".shoutout-option");

      const subjectStyle = document.getElementById("subjectStyle");
      const subjectPreview = document.getElementById("subjectPreview");
      const output = document.getElementById("messageOutput");

      const photoInput = document.getElementById("photoInput");
      const renderImageBtn = document.getElementById("renderImageBtn");
      const downloadWideBtn = document.getElementById("downloadWideBtn");
      const downloadStoryBtn = document.getElementById("downloadStoryBtn");
      const emailBtn = document.getElementById("emailBtn");

      const zoomSlider = document.getElementById("zoomSlider");
      const panXSlider = document.getElementById("panXSlider");
      const panYSlider = document.getElementById("panYSlider");
      const zoomLabel = document.getElementById("zoomLabel");
      const panXLabel = document.getElementById("panXLabel");
      const panYLabel = document.getElementById("panYLabel");

      const next1 = document.getElementById("next1");
      const next2 = document.getElementById("next2");
      const next3 = document.getElementById("next3");
      const next4 = document.getElementById("next4");

      const back2 = document.getElementById("back2");
      const back3 = document.getElementById("back3");
      const back4 = document.getElementById("back4");
      const back5 = document.getElementById("back5");

      const generateBtn = document.getElementById("generateBtn");
      const copyBtn = document.getElementById("copyBtn");

      // Step functions
      let currentStep = 1;
      function showStep(step){
        document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
        const el = document.getElementById("step"+step);
        if(el) el.classList.add("active");
        currentStep = step;

        // Stepper highlight
        document.querySelectorAll(".pill").forEach(p => {
          p.classList.toggle("active", parseInt(p.getAttribute("data-step"),10) === step);
        });
      }

      // Allow tapping pills to navigate (but keep validation)
      stepper.querySelectorAll(".pill").forEach(p => {
        p.addEventListener("click", () => {
          const target = parseInt(p.getAttribute("data-step"),10);
          // Only allow going forward if prerequisites met; always allow going backward.
          if(target < currentStep){
            showStep(target);
            return;
          }
          if(target === 2 && !canGoToStep2()) return showErr("Select a center first.");
          if(target === 3 && !canGoToStep3()) return showErr("Fill Ninja details first.");
          if(target === 4 && !canGoToStep4()) return showErr("Pick a shout-out reason first.");
          if(target === 5 && !canGoToStep5()) return showErr("Generate the message first.");
          showStep(target);
        });
      });

      function getSelectedReason(){
        const checked = document.querySelector('input[name="reason"]:checked');
        return checked ? checked.value : "";
      }

      function updateCenterUI(){
        const c = getCenter();
        centerEmailDisplay.textContent = c.email;
        next1.disabled = !c; // always enabled in practice
      }

      function updateSelectionVisuals(){
        optionCards.forEach(card => {
          const input = card.querySelector("input");
          card.classList.toggle("selected", !!(input && input.checked));
        });
        const reason = getSelectedReason();
        senseiRow.style.display = (reason === "tour") ? "block" : "none";
        updateNextButtons();
        updateSubjectPreview();
      }

      function updateSubjectPreview(){
        const c = getCenter();
        const style = subjectStyle.value;
        const reason = getSelectedReason() || currentReason || "belt";
        const subj = buildEmailSubject(style, nameInput.value, reason, c.label);
        subjectPreview.textContent = subj;
      }

      function canGoToStep2(){
        return !!getCenter();
      }
      function canGoToStep3(){
        return canGoToStep2() && !!nameInput.value.trim() && !!(senderInput.value || "").trim();
      }
      function canGoToStep4(){
        return canGoToStep3() && !!getSelectedReason();
      }
      function canGoToStep5(){
        return canGoToStep4() && !!(output.value || "").trim();
      }

      function updateNextButtons(){
        next1.disabled = !canGoToStep2();
        next2.disabled = !canGoToStep3();
        next3.disabled = !canGoToStep4();
        next4.disabled = !canGoToStep5();
      }

      // Initial
      updateCenterUI();
      updateNextButtons();
      updateSubjectPreview();

      // Center change
      centerSelect.addEventListener("change", () => {
        updateCenterUI();
        updateSubjectPreview();
        updateNextButtons();
      });

      // Ninja fields
      [nameInput, senderInput].forEach(el => el.addEventListener("input", () => {
        updateNextButtons();
        updateSubjectPreview();
      }));
      parentInput.addEventListener("input", updateSubjectPreview);
      pronounSelect.addEventListener("change", updateSubjectPreview);

      // Subject style
      subjectStyle.addEventListener("change", updateSubjectPreview);

      // Reason selection
      optionCards.forEach(card => {
        card.addEventListener("click", () => {
          const input = card.querySelector("input");
          if(input){
            input.checked = true;
            updateSelectionVisuals();
          }
        });
      });
      document.querySelectorAll('input[name="reason"]').forEach(i => {
        i.addEventListener("change", updateSelectionVisuals);
      });

      // Navigation buttons
      next1.addEventListener("click", () => showStep(2));
      back2.addEventListener("click", () => showStep(1));
      next2.addEventListener("click", () => showStep(3));
      back3.addEventListener("click", () => showStep(2));
      next3.addEventListener("click", () => showStep(4));
      back4.addEventListener("click", () => showStep(3));
      next4.addEventListener("click", () => showStep(5));
      back5.addEventListener("click", () => showStep(4));

      // Generate message
      generateBtn.addEventListener("click", () => {
        const c = getCenter();
        const name = nameInput.value;
        const parentName = parentInput.value;
        const reason = getSelectedReason();
        const custom = customInput.value;
        const senderName = senderInput.value || "Marina";
        const senseiName = senseiInput.value;
        const pronoun = getPronouns(pronounSelect.value);

        if(!c){
          showErr("Choose a center first.");
          showStep(1);
          return;
        }
        if(!name.trim()){
          showErr("Please enter the Ninja‚Äôs name first.");
          showStep(2);
          nameInput.focus();
          return;
        }
        if(!reason){
          showErr("Please choose what you‚Äôre shouting them out for.");
          showStep(3);
          return;
        }

        const core = buildCoreMessage(name, reason, custom, senseiName, pronoun);
        if(!core){
          showErr("Could not generate. Try again.");
          return;
        }

        latestCoreMessage = core;
        currentReason = reason;
        currentNinjaName = name.trim();

        const msg = buildFullMessage(name, reason, custom, senderName, senseiName, parentName, pronoun, c.centerName);
        output.value = msg;

        updateSubjectPreview();
        updateNextButtons();
        showOk("Generated! You can copy it or go to images.");
      });

      // Copy
      copyBtn.addEventListener("click", async () => {
        const text = (output.value || "").trim();
        if(!text){
          showErr("Generate the message first.");
          return;
        }
        const ok = await copyToClipboard(text);
        ok ? showOk("Copied! üìã") : showErr("Couldn‚Äôt copy automatically. Please copy manually.");
      });

      // Photo input
      photoInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if(file){
          handlePhotoFile(file);
          latestImageGenerated = false;
          showOk("Photo loaded! Drag/zoom then generate images.");
        }
      });

      // Slider labels + live rerender
      function refreshSliderLabels(){
        zoomLabel.textContent = `${parseFloat(zoomSlider.value).toFixed(2)}√ó`;
        panXLabel.textContent = panXSlider.value;
        panYLabel.textContent = panYSlider.value;
      }
      [zoomSlider, panXSlider, panYSlider].forEach(sl => {
        sl.addEventListener("input", () => {
          refreshSliderLabels();
          if(userImage && latestCoreMessage){
            renderShoutoutImages();
            downloadWideBtn.disabled = false;
            downloadStoryBtn.disabled = false;
          }
        });
      });
      refreshSliderLabels();

      // Drag-to-pan + wheel zoom on canvases
      function clamp(num, min, max){ return Math.max(min, Math.min(max, num)); }

      function attachCanvasInteractions(canvasEl){
        let dragging = false;
        let startX = 0, startY = 0;
        let startPanX = 0, startPanY = 0;

        canvasEl.addEventListener("pointerdown", (e) => {
          if(!userImage) return;
          dragging = true;
          canvasEl.setPointerCapture(e.pointerId);
          startX = e.clientX;
          startY = e.clientY;
          startPanX = parseFloat(panXSlider.value || "0");
          startPanY = parseFloat(panYSlider.value || "0");
        });

        canvasEl.addEventListener("pointermove", (e) => {
          if(!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          // sensitivity tuned for iPad/desktop
          const sens = 0.25;
          panXSlider.value = clamp(startPanX + dx * sens, -100, 100);
          panYSlider.value = clamp(startPanY + dy * sens, -100, 100);

          refreshSliderLabels();
          if(userImage && latestCoreMessage){
            renderShoutoutImages();
            downloadWideBtn.disabled = false;
            downloadStoryBtn.disabled = false;
          }
        });

        canvasEl.addEventListener("pointerup", () => { dragging = false; });
        canvasEl.addEventListener("pointercancel", () => { dragging = false; });

        canvasEl.addEventListener("wheel", (e) => {
          if(!userImage) return;
          e.preventDefault();
          const z = parseFloat(zoomSlider.value || "1");
          const delta = e.deltaY > 0 ? -0.06 : 0.06;
          const next = clamp(z + delta, parseFloat(zoomSlider.min), parseFloat(zoomSlider.max));
          zoomSlider.value = next.toFixed(2);
          refreshSliderLabels();

          if(userImage && latestCoreMessage){
            renderShoutoutImages();
            downloadWideBtn.disabled = false;
            downloadStoryBtn.disabled = false;
          }
        }, { passive:false });
      }
      attachCanvasInteractions(canvasWide);
      attachCanvasInteractions(canvasStory);

      // Render images
      renderImageBtn.addEventListener("click", () => {
        renderShoutoutImages();
        downloadWideBtn.disabled = false;
        downloadStoryBtn.disabled = false;
        showOk("Images generated!");
      });

      // Download
      downloadWideBtn.addEventListener("click", () => {
        const dataUrl = canvasWide.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = "ninja-shoutout-landscape.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showOk("Landscape downloaded.");
      });

      downloadStoryBtn.addEventListener("click", () => {
        const dataUrl = canvasStory.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = "ninja-shoutout-story.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showOk("Story downloaded.");
      });

      // Email
      emailBtn.addEventListener("click", () => {
        const text = (output.value || "").trim();
        if(!text){
          showErr("Generate the message first (Step 4) before emailing.");
          showStep(4);
          return;
        }
        if(!latestImageGenerated){
          showErr("Generate the images first, then download them to attach in your email.");
          return;
        }

        const c = getCenter();
        const style = subjectStyle.value || "simple";
        const reason = currentReason || getSelectedReason() || "belt";
        const subject = buildEmailSubject(style, nameInput.value, reason, c.label);

        // show the subject it generates (requested)
        showOk(`Subject: ${subject}`);

        const body =
          text +
          "\n\n---\n" +
          "Please see attached image files (ninja-shoutout-landscape.png and/or ninja-shoutout-story.png) for the shout-out pictures.\n" +
          "(Generated with Ninja Shout-Out Builder)";

        const mailto = `mailto:${encodeURIComponent(c.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
      });

      // Validation: enable Step 1 next immediately
      next1.disabled = false;

      // Keep next buttons updated initially
      updateSelectionVisuals();
      updateNextButtons();
      showStep(1);
    });
  </script>
</body>
</html>
